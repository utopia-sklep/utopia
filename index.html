<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Utopia sprzedaje</title>
<style>
  :root{--bg:#0d0f13;--panel:#12151b;--text:#e7eaf0;--muted:#aeb6c7;--accent:#e3b341;--card:#0f1319;--border:1.5px solid var(--accent);--radius:10px;--shadow:0 8px 20px rgba(0,0,0,.35)}
  *{box-sizing:border-box}
  html,body{margin:0;background:linear-gradient(180deg,#0b0d11,#0c1016 60%,#0a0c10);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  a{color:var(--accent)}
  .wrap{max-width:1200px;margin:24px auto;padding:16px;position:relative}
  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .right{margin-left:auto}
  .gem{width:28px;height:28px;border:var(--border);border-radius:8px;background:radial-gradient(circle at 30% 30%,#ffd789,#8a6a18);box-shadow:inset 0 0 12px rgba(255,215,137,.6)}
  h1{font-size:20px;margin:0}
  .toolbar{background:#12151b;border:var(--border);border-radius:var(--radius);padding:10px;box-shadow:var(--shadow)}
  .tabsRow{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:10px 14px;border:var(--border);border-radius:10px;background:linear-gradient(180deg,#212632,#1a1f28);cursor:pointer;font-weight:700;color:#f7f8fc}
  .tab[aria-selected="true"]{background:linear-gradient(180deg,#2a313f,#1f2430);box-shadow:inset 0 0 0 2px rgba(227,179,65,.33)}
  .filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:flex-end}
  .label{font-size:12px;color:var(--muted)}
  .input,.btn{height:40px;border-radius:8px;border:var(--border);background:#0f141b;color:var(--text);padding:0 12px}
  .btn{cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(180deg,#2a2f3a,#1a1f27)}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:16px;margin-top:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:var(--border);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
  .item-img{width:100%;height:auto;border-radius:8px;border:1px solid rgba(227,179,65,.35);background:#0b0e12}
  .meta{margin-top:10px;font-size:14px;line-height:1.6}
  .table{background:#12151b;border:var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
  table{width:100%;border-collapse:collapse}
  thead{background:linear-gradient(180deg,#1b212b,#141922)}
  th,td{padding:12px;border-bottom:1px solid rgba(227,179,65,.18);text-align:left;font-size:14px}
  th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.6px}
  tr:hover td{background:#121722}
  .thumb{width:52px;height:52px;border-radius:6px;border:1px solid rgba(227,179,65,.35);background:#0b0e12;object-fit:cover}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(227,179,65,.5);font-size:12px}
  .empty{padding:24px;text-align:center;color:var(--muted)}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
  .overlay.open{display:flex}
  .modal{width:min(1040px,95vw);background:#12151b;border:var(--border);border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.6);overflow:hidden;max-height:85vh}
  .modal header{padding:14px 16px;margin:0;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(180deg,#1b212b,#141922)}
  .modal h2{font-size:16px;margin:0}
  .modal .content{padding:16px;overflow:auto;max-height:60vh}
  .closeBtn{border:var(--border);background:transparent;color:var(--text);border-radius:8px;height:34px;padding:0 10px;cursor:pointer}
  .form-grid{display:grid;grid-template-columns:460px 1fr;gap:16px}
  @media (max-width:980px){.form-grid{grid-template-columns:1fr}}
  .drop{border:2px dashed rgba(227,179,65,.6);border-radius:12px;height:300px;display:flex;align-items:center;justify-content:center;background:#0f1419;cursor:pointer;text-align:center;padding:12px}
  .drop.drag{background:#131a22}
  .drop img{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px}
  .cols{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px}
  .cols .input{height:44px;width:100%}
  .hint{font-size:12px;color:var(--muted);margin-top:8px}
  .actions{white-space:nowrap}
  .iconbtn{border:var(--border);background:#0f141b;color:#fff;border-radius:8px;height:34px;padding:0 10px;cursor:pointer;margin-right:6px}
  .adminbox{position:fixed;right:16px;bottom:16px;background:#12151b;border:var(--border);border-radius:12px;padding:10px;box-shadow:var(--shadow);min-width:260px}
  .adminbox .row{display:flex;gap:8px;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <span class="gem"></span><h1>Utopia sprzedaje</h1>
    <div class="right"><button id="settingsBtn" class="btn">ZmieÅ„ ustawienia</button></div>
  </header>

  <section class="toolbar">
    <div class="tabsRow">
      <div class="tabs">
        <button class="tab" data-type="Legendarny" aria-selected="true">Legendarny</button>
        <button class="tab" data-type="Heroiczny">Heroiczny</button>
        <button class="tab" data-type="Unikatowy">Unikatowy</button>
        <button class="tab" data-type="Inny">Inny</button>
        <button class="tab" data-type="Wszystkie">Wszystkie</button>
      </div>
      <div class="tabs" id="viewTabs">
        <button class="tab" data-view="all"   aria-selected="true">Wszystkie oferty</button>
        <button class="tab" data-view="mine">Twoje oferty</button>
      </div>
    </div>

    <div class="filters">
      <div><div class="label">min. lvl</div><input id="minLvl" class="input" type="number" placeholder="np. 50"></div>
      <div><div class="label">max. lvl</div><input id="maxLvl" class="input" type="number" placeholder="np. 120"></div>
      <button id="searchBtn" class="btn primary">szukaj</button>
      <button id="resetBtn" class="btn">reset</button>
      <div style="flex:1"></div>
      <button id="addBtn" class="btn primary">+ Dodaj ofertÄ™</button>
    </div>
  </section>

  <section class="grid">
    <aside class="card">
      <img class="item-img" id="pImg" referrerpolicy="no-referrer" alt="PodglÄ…d" src="">
      <div class="meta" id="pMeta">
        <div>Typ: <b>â€”</b></div><div>LVL: <b>â€”</b></div><div>Cena: <b>â€”</b></div><div>Kontakt: <b>â€”</b></div>
      </div>
    </aside>

    <section class="table">
      <table>
        <thead>
          <tr><th>lvl</th><th>przedmiot</th><th>iloÅ›Ä‡</th><th>cena</th><th>kontakt dc.</th><th></th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="empty" class="empty">Brak ofert â€” dodaj pierwszÄ…! ðŸ™‚</div>
    </section>
  </section>
</div>

<!-- MODAL: dodawanie/edycja -->
<div id="overlay" class="overlay">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="titleAdd">
    <header><h2 id="titleAdd">Dodawanie oferty</h2><button class="closeBtn" id="closeBtn">Zamknij âœ•</button></header>
    <div class="content">
      <div class="form-grid">
        <div>
          <div id="drop" class="drop" tabindex="0">
            <div id="dropHint"><strong>Dodaj zdjÄ™cie</strong><br>PrzeciÄ…gnij plik, <u>wklej (Ctrl+V)</u> lub kliknij (PNG/JPG)</div>
            <img id="dropImg" alt="ZaÅ‚adowany obraz" style="display:none">
            <input id="imgFile" type="file" accept="image/*" hidden>
          </div>
        </div>
        <div>
          <div class="cols">
            <input id="lvlIn" class="input" type="number" min="1" placeholder="lvl (np. 93)">
            <select id="typeIn" class="input"><option>Legendarny</option><option>Heroiczny</option><option>Unikatowy</option><option>Inny</option></select>
            <input id="priceIn" class="input" type="text" placeholder="cena (np. 500m)">
            <input id="contactIn" class="input" type="text" placeholder="kontakt (np. @twÃ³jNick)">
            <label class="input" style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="multiChk"> WiÄ™cej niÅ¼ jeden
            </label>
            <input id="qtyIn" class="input" type="number" min="2" placeholder="iloÅ›Ä‡" disabled>
          </div>
          <div id="formHint" class="hint" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
    <footer style="display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;background:#121722;border-top:1px solid rgba(227,179,65,.2)">
      <button class="btn primary" id="saveBtn">Zapisz</button>
    </footer>
  </div>
</div>

<!-- MODAL: ustawienia profilu -->
<div id="profile" class="overlay">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pTitle">
    <header><h2 id="pTitle">Ustawienia profilu</h2><button class="closeBtn" id="pClose">Zamknij âœ•</button></header>
    <div class="content">
      <div class="cols">
        <div>
          <div class="label">Nick (np. z Discorda)</div>
          <input id="nickSet" class="input" type="text" placeholder="@nick#0000">
        </div>
        <div>
          <div class="label">PIN (min. 4 cyfry)</div>
          <input id="pinSet" class="input" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="np. 1234">
        </div>
      </div>
      <div id="pErr" class="hint" style="color:#ff9a9a;margin-top:8px"></div>
    </div>
    <footer style="display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;background:#121722;border-top:1px solid rgba(227,179,65,.2)">
      <button id="pReset" class="btn">Resetuj profil</button>
      <button id="pSave" class="btn primary">Zapisz</button>
    </footer>
  </div>
</div>

<!-- Admin login box -->
<div class="adminbox" id="adminBox">
  <div id="adminStatus"><b>Admin:</b> nie zalogowany</div>
  <div id="adminLoginArea">
    <div class="label" style="margin-top:6px">HasÅ‚o admina</div>
    <input id="adminPass" class="input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
    <div class="row"><button id="adminLogin" class="btn primary">Zaloguj</button></div>
  </div>
  <div id="adminLogoutArea" style="display:none">
    <div class="row"><button id="adminLogout" class="btn">Wyloguj</button></div>
  </div>
</div>

<script>
  /* === ADRES API === */
  const API_URL = 'https://script.google.com/macros/s/AKfycbzWPygueePL-z1re__YROKMhY_mgiIbKp64mVdDgvovjBb5jxTe3RjgISQUEVbHZnvGVQ/exec';

  /* === profil (nick + PIN -> ownerId) === */
  const OWNER_KEY='utopia_owner_v1';
  const ADMIN_KEY='utopia_admin_token_v1';           // (b64)
  const ADMIN_KEY_HEX='utopia_admin_token_hex_v1';   // (hex) â€” nowy klucz
  let OWNER = loadOwner();
  let ADMIN_TOKEN = localStorage.getItem(ADMIN_KEY) || '';            // b64 (dla zgodnoÅ›ci wstecz)
  let ADMIN_TOKEN_HEX = localStorage.getItem(ADMIN_KEY_HEX) || '';    // hex (nowa Å›cieÅ¼ka)

  function loadOwner(){ try{return JSON.parse(localStorage.getItem(OWNER_KEY)||'null')}catch(e){return null} }
  async function deriveOwnerId(nick, pin){
    const enc = new TextEncoder();
    const salt = enc.encode('salt:'+nick+':utopia-pepper-v1');
    const keyMat = await crypto.subtle.importKey('raw', enc.encode(pin),'PBKDF2',false,['deriveBits']);
    const bits = await crypto.subtle.deriveBits({name:'PBKDF2',hash:'SHA-256',salt,iterations:100000}, keyMat, 256);
    return btoa(String.fromCharCode(...new Uint8Array(bits)));
  }
  async function saveOwner(nick,pin){
    const ownerId = await deriveOwnerId(nick,pin);
    OWNER = {nick, ownerId};
    localStorage.setItem(OWNER_KEY, JSON.stringify(OWNER));
  }

  async function sha256b64(str){
    const enc = new TextEncoder();
    const hash = await crypto.subtle.digest('SHA-256', enc.encode(str));
    return btoa(String.fromCharCode(...new Uint8Array(hash)));
  }
  async function sha256hex(str){
    const enc = new TextEncoder();
    const hash = await crypto.subtle.digest('SHA-256', enc.encode(str));
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  /* === API === */
  async function apiList(){ const r = await fetch(API_URL+'?action=list', {cache:'no-store'}); return r.json(); }
  async function apiAdd(offer, blob){
    const imgData = blob ? await blobToDataURL(blob) : '';
    const body = JSON.stringify({ action:'add', ...offer, imgData });
    const r = await fetch(API_URL, { method:'POST', mode:'cors', headers:{ 'Content-Type':'application/json' }, body });
    const text = await r.text();
    try { return JSON.parse(text); }
    catch { return {ok:false, error:`HTTP ${r.status} ${text.slice(0,200)}`}; }
  }
  async function apiDelete(id){
    const body = JSON.stringify({ action:'delete', id,
      ownerIdTry: OWNER?.ownerId || '', adminToken: ADMIN_TOKEN || '', adminTokenHex: ADMIN_TOKEN_HEX || '' });
    const r = await fetch(API_URL, { method:'POST', mode:'cors', headers:{ 'Content-Type':'application/json' }, body });
    const text = await r.text();
    try { return JSON.parse(text); }
    catch { return {ok:false, error:`HTTP ${r.status} ${text.slice(0,200)}`}; }
  }
  async function apiUpdate(id, fields, blob){
    const imgData = blob ? await blobToDataURL(blob) : '';
    const body = JSON.stringify({ action:'update', id, ...fields,
      imgData, ownerIdTry: OWNER?.ownerId || '', adminToken: ADMIN_TOKEN || '', adminTokenHex: ADMIN_TOKEN_HEX || '' });
    const r = await fetch(API_URL, { method:'POST', mode:'cors', headers:{ 'Content-Type':'application/json' }, body });
    const text = await r.text();
    try { return JSON.parse(text); }
    catch { return {ok:false, error:`HTTP ${r.status} ${text.slice(0,200)}`}; }
  }
  function blobToDataURL(blob){ return new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(blob); }); }

  /* === Pomocnicze: miniatury i obrazki === */
  function toThumb(url){
    if(!url) return '';
    // JeÅ›li peÅ‚ny thumbnail juÅ¼ jest
    if(url.includes('drive.google.com/thumbnail?id=')) return url;
    // Link typu /file/d/<ID>/view
    let m = url.match(/\/file\/d\/([^/]+)/);
    if(m) return `https://drive.google.com/thumbnail?id=${m[1]}&sz=w1600`;
    // Link z parametrem id=...
    m = url.match(/[?&]id=([^&]+)/);
    if(m) return `https://drive.google.com/thumbnail?id=${m[1]}&sz=w1600`;
    // Samo ID pliku (bez protokoÅ‚u)
    if(/^[a-zA-Z0-9_-]{20,}$/.test(url)) return `https://drive.google.com/thumbnail?id=${url}&sz=w1600`;
    // Inne hosty (googleusercontent, wÅ‚asne CDN) â€” zostaw jak jest
    return url;
  }
  function setImg(el, rawUrl){
    const primary = toThumb(rawUrl);
    el.referrerPolicy = 'no-referrer';
    el.src = primary;
    el.onerror = ()=>{
      // Fallback 1: sprÃ³buj bez miniatury
      if(/^https?:\/\//i.test(rawUrl)){
        el.onerror=null; el.src = rawUrl; return;
      }
      // Fallback 2: bezpoÅ›rednie uc?export=view&id=...
      if(/^[a-zA-Z0-9_-]{20,}$/.test(rawUrl)){
        el.onerror=null; el.src = `https://drive.google.com/uc?export=view&id=${rawUrl}`; return;
      }
    };
  }

  /* === UI / lista === */
  let REMOTE=[];
  const tabs=document.querySelectorAll('.tab[data-type]');
  const viewTabs=document.querySelectorAll('#viewTabs .tab');
  const minEl=document.getElementById('minLvl'), maxEl=document.getElementById('maxLvl'), tbody=document.getElementById('tbody'), empty=document.getElementById('empty'), previewImg=document.getElementById('pImg');
  const state={type:'Wszystkie', view:'all', min:'', max:''};

  tabs.forEach(b=>b.addEventListener('click',()=>{state.type=b.dataset.type;tabs.forEach(t=>t.setAttribute('aria-selected',String(t===b)));render()}));
  viewTabs.forEach(b=>b.addEventListener('click',()=>{state.view=b.dataset.view;viewTabs.forEach(t=>t.setAttribute('aria-selected',String(t===b)));render()}));

  document.getElementById('searchBtn').addEventListener('click',()=>{state.min=minEl.value?+minEl.value:'';state.max=maxEl.value?+maxEl.value:'';render()});
  document.getElementById('resetBtn').addEventListener('click',()=>{minEl.value=maxEl.value='';state.min=state.max='';state.type='Wszystkie';state.view='all';tabs.forEach(t=>t.setAttribute('aria-selected',t.dataset.type==='Wszystkie'));viewTabs.forEach(t=>t.setAttribute('aria-selected',t.dataset.view==='all'));render()});

  function typeMatches(t){ if(state.type==='Wszystkie') return true; if(state.type==='Inny') return t==='Inny'||t==='Inne'; return t===state.type; }
  function byFilters(x){
    if(!typeMatches(x.type)) return false;
    if(state.min!=='' && x.lvl<state.min) return false;
    if(state.max!=='' && x.lvl>state.max) return false;
    if(state.view==='mine'){
      if(!OWNER || !OWNER.ownerId) return false;
      return x.ownerId === OWNER.ownerId;
    }
    return true;
  }

  async function loadAndRender(){
    REMOTE = await apiList();
    render();
  }

  function render(){
    const data = REMOTE.filter(byFilters).sort((a,b)=>a.lvl-b.lvl || a.type.localeCompare(b.type));
    tbody.innerHTML=''; if(!data.length){ empty.hidden=false; setPreviewEmpty(); return } else empty.hidden=true;
    for(const it of data){
      const qtyTxt = (it.qty && Number(it.qty)>1) ? it.qty : '';
      const isOwner = !!(OWNER && it.ownerId && OWNER.ownerId===it.ownerId);
      const canAdmin = !!(ADMIN_TOKEN || ADMIN_TOKEN_HEX);
      const showActions = isOwner || canAdmin;

      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><span class="badge">${it.lvl}</span></td>
        <td><div style="display:flex;align-items:center;gap:10px">
              <img class="thumb" referrerpolicy="no-referrer" alt="miniatura">
              <div style="font-size:12px;color:#aeb6c7">${it.type||''}</div>
            </div></td>
        <td>${qtyTxt}</td>
        <td>${it.price||''}</td>
        <td><a href="#" title="Kopiuj kontakt">${it.contact||''}</a></td>
        <td class="actions">${showActions?`
          <button class="iconbtn edit" title="Edytuj">âœŽ</button>
          <button class="iconbtn del"  title="UsuÅ„">âœ•</button>`:''}
        </td>`;

      // Ustawienie obrazka z fallbackami
      const imgEl = tr.querySelector('.thumb');
      setImg(imgEl, it.imgUrl||it.fileId||'');

      tr.querySelector('a').addEventListener('click',e=>{e.preventDefault(); if(it.contact) navigator.clipboard.writeText(it.contact);});
      tr.addEventListener('click',e=>{ if(e.target.closest('.iconbtn')) return; show(it); });
      if(showActions){
        tr.querySelector('.del').addEventListener('click',()=> onDelete(it));
        tr.querySelector('.edit').addEventListener('click',()=> onEdit(it));
      }
      tbody.appendChild(tr);
    }
    if(data[0]) show(data[0]); else setPreviewEmpty();
  }
  function setPreviewEmpty(){
    previewImg.src=''; document.getElementById('pMeta').innerHTML=`<div>Typ: <b>â€”</b></div><div>LVL: <b>â€”</b></div><div>Cena: <b>â€”</b></div><div>Kontakt: <b>â€”</b></div>`;
  }
  function show(it){
    setImg(previewImg, it.imgUrl||it.fileId||'');
    document.getElementById('pMeta').innerHTML =
      `<div>Typ: <b>${it.type||'â€”'}</b></div><div>LVL: <b>${it.lvl||'â€”'}</b></div><div>Cena: <b>${it.price||'â€”'}</b></div><div>Kontakt: <b>${it.contact||'â€”'}</b></div>`;
  }

  /* === Dodawanie / Edycja === */
  const overlay=document.getElementById('overlay'), addBtn=document.getElementById('addBtn'), closeBtn=document.getElementById('closeBtn'), saveBtn=document.getElementById('saveBtn'), hint=document.getElementById('formHint');
  const drop=document.getElementById('drop'), dropImg=document.getElementById('dropImg'), dropHint=document.getElementById('dropHint'), imgFile=document.getElementById('imgFile');
  const lvlIn=document.getElementById('lvlIn'), typeIn=document.getElementById('typeIn'), priceIn=document.getElementById('priceIn'), contactIn=document.getElementById('contactIn');
  const multiChk=document.getElementById('multiChk'), qtyIn=document.getElementById('qtyIn');
  let imageBlob=null, EDIT_MODE=false, CURRENT=null;

  multiChk.addEventListener('change',()=>{ qtyIn.disabled = !multiChk.checked; if(!multiChk.checked) qtyIn.value=''; });

  function openModal(edit=false, item=null){
    EDIT_MODE = edit; CURRENT = item;
    document.getElementById('titleAdd').textContent = edit ? 'Edytuj ofertÄ™' : 'Dodawanie oferty';
    saveBtn.textContent = 'Zapisz';
    overlay.classList.add('open'); hint.textContent=''; saveBtn.disabled=false; drop.focus();

    imageBlob=null; dropImg.style.display='none'; dropHint.style.display='block';
    lvlIn.value=priceIn.value=contactIn.value=''; typeIn.value='Legendarny'; multiChk.checked=false; qtyIn.disabled=true; qtyIn.value='';

    if(edit && item){
      lvlIn.value = item.lvl; typeIn.value = item.type; priceIn.value = item.price; contactIn.value = item.contact;
      if(item.qty && Number(item.qty)>1){ multiChk.checked=true; qtyIn.disabled=false; qtyIn.value=item.qty; }
      if(item.imgUrl||item.fileId){ setImg(dropImg, item.imgUrl||item.fileId); dropImg.style.display='block'; dropHint.style.display='none'; }
    }
  }
  function closeModal(){ overlay.classList.remove('open'); }

  addBtn.addEventListener('click',()=>openModal(false,null));
  closeBtn.addEventListener('click',closeModal);
  overlay.addEventListener('click',e=>{if(e.target===overlay) closeModal()});
  document.addEventListener('keydown',e=>{if(overlay.classList.contains('open')&&e.key==='Escape') closeModal()});

  ;['dragenter','dragover','dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation()}));
  drop.addEventListener('click',()=>imgFile.click());
  drop.addEventListener('drop',e=> handleFiles(e.dataTransfer.files));
  imgFile.addEventListener('change',()=>handleFiles(imgFile.files));
  document.addEventListener('paste',e=>{
    if(!overlay.classList.contains('open')) return;
    const items=e.clipboardData&&e.clipboardData.items; if(!items) return;
    for(const it of items){ if(it.type&&it.type.startsWith('image/')){ const f=it.getAsFile(); if(f) handleFile(f); break; } }
  });
  function handleFiles(list){ if(list&&list[0]) handleFile(list[0]) }
  function handleFile(file){
    if(!file.type.startsWith('image/')){ hint.textContent='To nie jest obraz.'; return }
    const reader=new FileReader();
    reader.onload = ev => compressToMax(ev.target.result,800,blob=>{ imageBlob=blob; dropImg.src=URL.createObjectURL(blob); dropImg.style.display='block'; dropHint.style.display='none'; });
    reader.readAsDataURL(file);
  }
  function compressToMax(dataUrl,max,cb){ const img=new Image(); img.onload=()=>{ const s=Math.min(1,max/Math.max(img.width,img.height)); const w=Math.round(img.width*s),h=Math.round(img.height*s); const c=document.createElement('canvas'); c.width=w;c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); c.toBlob(b=>cb(b),'image/png',0.95); }; img.src=dataUrl; }

  saveBtn.addEventListener('click', async ()=>{
    const lvl=parseInt(lvlIn.value,10), type=typeIn.value, price=(priceIn.value||'').trim(), contact=(contactIn.value||'').trim();
    const qty = multiChk.checked ? Math.max(2, parseInt(qtyIn.value||'2',10)) : 1;
    if(!lvl||!price||!contact){ hint.textContent='UzupeÅ‚nij: lvl, cena, kontakt.'; return }
    saveBtn.disabled=true;

    if(!EDIT_MODE){
      const offer = { type, lvl, price, qty, contact, ownerId: OWNER?.ownerId||'' };
      let res;
      try {
        res = await apiAdd(offer, imageBlob);
      } catch (e) {
        res = { ok:false, error: (e && e.message) ? e.message : String(e) };
      }
      saveBtn.disabled=false;
      if(!res || !res.ok){
        console.error('Save error response:', res);
        hint.textContent = 'BÅ‚Ä…d zapisu: ' + (res && res.error ? res.error : 'sprÃ³buj ponownie.');
        return;
      }
    } else {
      const fields = { type, lvl, price, qty, contact };
      let res;
      try {
        res = await apiUpdate(CURRENT.id, fields, imageBlob);
      } catch (e) {
        res = { ok:false, error: (e && e.message) ? e.message : String(e) };
      }
      saveBtn.disabled=false;
      if(!res || !res.ok){
        console.error('Update error response:', res);
        hint.textContent = 'BÅ‚Ä…d edycji: ' + (res && res.error ? res.error : 'sprÃ³buj ponownie.');
        return;
      }
    }
    closeModal(); await loadAndRender();
  });

  async function onDelete(item){
    const res = await apiDelete(item.id).catch(()=>({ok:false}));
    if(!res.ok){ alert(res.error || 'BÅ‚Ä…d operacji.'); return }
    await loadAndRender();
  }
  function onEdit(item){ openModal(true,item); }

  /* === Ustawienia (profil) === */
  const profileEl=document.getElementById('profile'), settingsBtn=document.getElementById('settingsBtn');
  const pClose=document.getElementById('pClose'), pSave=document.getElementById('pSave'), pReset=document.getElementById('pReset'), pErr=document.getElementById('pErr');
  const nickSet=document.getElementById('nickSet'), pinSet=document.getElementById('pinSet');

  settingsBtn.addEventListener('click',()=>{ nickSet.value=OWNER?.nick||''; pinSet.value=''; pErr.textContent=''; profileEl.classList.add('open'); });
  pClose.addEventListener('click',()=>profileEl.classList.remove('open'));
  profileEl.addEventListener('click',e=>{ if(e.target===profileEl) profileEl.classList.remove('open'); });

  pSave.addEventListener('click', async ()=>{
    const n=(nickSet.value||'').trim(), p=(pinSet.value||'').trim();
    if(n.length<2||p.length<4){ pErr.textContent='Podaj nick i PIN (min. 4 cyfry).'; return; }
    await saveOwner(n,p); profileEl.classList.remove('open'); await loadAndRender();
  });
  pReset.addEventListener('click',()=>{
    localStorage.removeItem(OWNER_KEY); OWNER=null; profileEl.classList.remove('open'); loadAndRender();
  });

  /* === Admin login === */
  const adminStatus=document.getElementById('adminStatus');
  const adminLoginArea=document.getElementById('adminLoginArea');
  const adminLogoutArea=document.getElementById('adminLogoutArea');
  const adminPass=document.getElementById('adminPass');
  const adminLoginBtn=document.getElementById('adminLogin');
  const adminLogoutBtn=document.getElementById('adminLogout');

  function refreshAdminUI(){
    if(ADMIN_TOKEN || ADMIN_TOKEN_HEX){
      adminStatus.innerHTML = '<b>Admin:</b> zalogowany';
      adminLoginArea.style.display='none';
      adminLogoutArea.style.display='block';
    }else{
      adminStatus.innerHTML = '<b>Admin:</b> nie zalogowany';
      adminLoginArea.style.display='block';
      adminLogoutArea.style.display='none';
    }
    render();
  }
  adminLoginBtn.addEventListener('click', async ()=>{
    const pw=(adminPass.value||'').trim(); if(!pw) return;
    // Wylicz obie wersje tokenu dla kompatybilnoÅ›ci z backendem
    ADMIN_TOKEN = await sha256b64(pw);
    ADMIN_TOKEN_HEX = await sha256hex(pw);
    localStorage.setItem(ADMIN_KEY, ADMIN_TOKEN);
    localStorage.setItem(ADMIN_KEY_HEX, ADMIN_TOKEN_HEX);
    adminPass.value=''; refreshAdminUI();
  });
  adminLogoutBtn.addEventListener('click', ()=>{
    ADMIN_TOKEN=''; ADMIN_TOKEN_HEX='';
    localStorage.removeItem(ADMIN_KEY); localStorage.removeItem(ADMIN_KEY_HEX);
    refreshAdminUI();
  });

  /* start */
  async function start(){ await loadAndRender(); refreshAdminUI(); }
  function setPreviewEmpty(){ previewImg.src=''; document.getElementById('pMeta').innerHTML=`<div>Typ: <b>â€”</b></div><div>LVL: <b>â€”</b></div><div>Cena: <b>â€”</b></div><div>Kontakt: <b>â€”</b></div>`; }
  start();
</script>
</body>
</html>
