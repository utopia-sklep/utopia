<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Utopia sprzedaje</title>
<style>
  :root{--bg:#0d0f13;--panel:#12151b;--text:#e7eaf0;--muted:#aeb6c7;--accent:#e3b341;--card:#0f1319;--border:1.5px solid var(--accent);--radius:10px;--shadow:0 8px 20px rgba(0,0,0,.35)}
  *{box-sizing:border-box}
  html,body{margin:0;background:linear-gradient(180deg,#0b0d11,#0c1016 60%,#0a0c10);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  a{color:var(--accent)}
  .wrap{max-width:1200px;margin:24px auto;padding:16px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .gem{width:28px;height:28px;border:var(--border);border-radius:8px;background:radial-gradient(circle at 30% 30%,#ffd789,#8a6a18);box-shadow:inset 0 0 12px rgba(255,215,137,.6)}
  h1{font-size:20px;margin:0}
  .toolbar{background:#12151b;border:var(--border);border-radius:var(--radius);padding:10px;box-shadow:var(--shadow)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:10px 14px;border:var(--border);border-radius:10px;background:linear-gradient(180deg,#212632,#1a1f28);cursor:pointer;font-weight:700;color:#f7f8fc}
  .tab[aria-selected="true"]{background:linear-gradient(180deg,#2a313f,#1f2430);box-shadow:inset 0 0 0 2px rgba(227,179,65,.33)}
  .filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:flex-end}
  .label{font-size:12px;color:var(--muted)}
  .input,.btn{height:40px;border-radius:8px;border:var(--border);background:#0f141b;color:var(--text);padding:0 12px}
  .btn{cursor:pointer;font-weight:700}
  .btn.primary{background:linear-gradient(180deg,#2a2f3a,#1a1f27)}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:16px;margin-top:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:var(--border);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
  .item-img{width:100%;height:auto;border-radius:8px;border:1px solid rgba(227,179,65,.35);background:#0b0e12}
  .meta{margin-top:10px;font-size:14px;line-height:1.6}
  .table{background:#12151b;border:var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
  table{width:100%;border-collapse:collapse}
  thead{background:linear-gradient(180deg,#1b212b,#141922)}
  th,td{padding:12px;border-bottom:1px solid rgba(227,179,65,.18);text-align:left;font-size:14px}
  th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.6px}
  tr:hover td{background:#121722}
  .thumb{width:52px;height:52px;border-radius:6px;border:1px solid rgba(227,179,65,.35);background:#0b0e12;object-fit:cover}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(227,179,65,.5);font-size:12px}
  .empty{padding:24px;text-align:center;color:var(--muted)}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
  .overlay.open{display:flex}
  .modal{width:min(1040px,95vw);background:#12151b;border:var(--border);border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.6);overflow:hidden;max-height:85vh}
  .modal header{padding:14px 16px;margin:0;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(180deg,#1b212b,#141922)}
  .modal h2{font-size:16px;margin:0}
  .modal .content{padding:16px;overflow:auto;max-height:60vh}
  .closeBtn{border:var(--border);background:transparent;color:var(--text);border-radius:8px;height:34px;padding:0 10px;cursor:pointer}
  .form-grid{display:grid;grid-template-columns:460px 1fr;gap:16px}
  @media (max-width:980px){.form-grid{grid-template-columns:1fr}}
  .drop{border:2px dashed rgba(227,179,65,.6);border-radius:12px;height:300px;display:flex;align-items:center;justify-content:center;background:#0f1419;cursor:pointer;text-align:center;padding:12px}
  .drop.drag{background:#131a22}
  .drop img{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px}
  .cols{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px}
  .cols .input{height:44px;width:100%}
  .hint{font-size:12px;color:var(--muted);margin-top:8px}
  .confirm{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);padding:16px}
  .confirm.open{display:flex}
  .confirm .box{background:#12151b;border:var(--border);border-radius:12px;min-width:320px;max-width:95vw;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.6)}
  .confirm .row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .field{display:flex;flex-direction:column;gap:6px;margin-top:8px}
  .small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header><span class="gem"></span><h1>Utopia sprzedaje</h1></header>

  <section class="toolbar">
    <div class="tabs">
      <button class="tab" data-type="Legendarny" aria-selected="true">Legendarny</button>
      <button class="tab" data-type="Heroiczny">Heroiczny</button>
      <button class="tab" data-type="Unikatowy">Unikatowy</button>
      <button class="tab" data-type="Inny">Inny</button>
      <button class="tab" data-type="Wszystkie">Wszystkie</button>
    </div>
    <div class="filters">
      <div><div class="label">min. lvl</div><input id="minLvl" class="input" type="number" placeholder="np. 50"></div>
      <div><div class="label">max. lvl</div><input id="maxLvl" class="input" type="number" placeholder="np. 120"></div>
      <button id="searchBtn" class="btn primary">szukaj</button>
      <button id="resetBtn" class="btn">reset</button>
      <div style="flex:1"></div>
      <button id="addBtn" class="btn primary">+ Dodaj ofertÄ™</button>
    </div>
  </section>

  <section class="grid">
    <aside class="card">
      <img class="item-img" id="pImg" alt="" src="">
      <div class="meta" id="pMeta">
        <div>Typ: <b>â€”</b></div><div>LVL: <b>â€”</b></div><div>Cena: <b>â€”</b></div><div>Kontakt: <b>â€”</b></div>
      </div>
    </aside>

    <section class="table">
      <table>
        <thead><tr><th>lvl</th><th>przedmiot</th><th>cena</th><th>kontakt dc.</th><th></th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="empty" class="empty">Brak ofert â€” dodaj pierwszÄ…! ðŸ™‚</div>
    </section>
  </section>
</div>

<!-- MODAL: dodawanie -->
<div id="overlay" class="overlay">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="titleAdd">
    <header><h2 id="titleAdd">Dodawanie oferty</h2><button class="closeBtn" id="closeBtn">Zamknij âœ•</button></header>
    <div class="content">
      <div class="form-grid">
        <div>
          <div id="drop" class="drop" tabindex="0">
            <div id="dropHint"><strong>Dodaj zdjÄ™cie</strong><br>PrzeciÄ…gnij plik, <u>wklej (Ctrl+V)</u> lub kliknij (PNG/JPG)</div>
            <img id="dropImg" alt="" style="display:none">
            <input id="imgFile" type="file" accept="image/*" hidden>
          </div>
          <div class="hint">Obraz kompresujemy do max. 800 px i wysyÅ‚amy do serwera.</div>
        </div>
        <div>
          <div class="cols">
            <input id="lvlIn" class="input" type="number" min="1" placeholder="lvl (np. 93)">
            <select id="typeIn" class="input"><option>Legendarny</option><option>Heroiczny</option><option>Unikatowy</option><option>Inny</option></select>
            <input id="priceIn" class="input" type="text" placeholder="cena (np. 500m)">
            <input id="contactIn" class="input" type="text" placeholder="kontakt (np. @twÃ³jNick)">
          </div>
          <div id="formHint" class="hint" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
    <footer style="display:flex;gap:8px;justify-content:flex-end;padding:12px 16px;background:#121722;border-top:1px solid rgba(227,179,65,.2)">
      <button class="btn primary" id="saveBtn">Dodaj</button>
    </footer>
  </div>
</div>

<!-- MODAL: usuwanie -->
<div id="confirm" class="confirm" role="dialog" aria-modal="true" aria-labelledby="cTitle">
  <div class="box">
    <div id="cTitle" style="font-weight:700;margin-bottom:6px">Potwierdzenie</div>
    <div>Czy na pewno chcesz zamknÄ…Ä‡ ofertÄ™?</div>
    <div class="field">
      <label class="small" for="pinConfirm">Wpisz <b>PIN</b>, aby potwierdziÄ‡</label>
      <input id="pinConfirm" class="input" type="password" placeholder="PIN" inputmode="numeric" pattern="[0-9]*">
    </div>
    <div id="cErr" class="small" style="color:#ff9a9a"></div>
    <div class="row"><button id="cNo" class="btn">nie</button><button id="cYes" class="btn primary">tak</button></div>
  </div>
</div>

<!-- MODAL: profil (nick + PIN) -->
<div id="profile" class="confirm" role="dialog" aria-modal="true" aria-labelledby="pTitle">
  <div class="box">
    <div id="pTitle" style="font-weight:700;margin-bottom:6px">Ustaw swÃ³j profil</div>
    <div class="field"><label class="small" for="nickSet">Nick (np. z Discorda)</label><input id="nickSet" class="input" type="text" placeholder="np. @arek#1234"></div>
    <div class="field"><label class="small" for="pinSet">PIN (min. 4 cyfry â€“ nie zapisujemy go wprost)</label><input id="pinSet" class="input" type="password" placeholder="np. 1234" inputmode="numeric" pattern="[0-9]*"></div>
    <div id="pErr" class="small" style="color:#ff9a9a"></div>
    <div class="row"><button id="pSave" class="btn primary">zapisz</button></div>
  </div>
</div>

<script>
  /* === ADRES API â€“ PODMIEÅƒ NA SWÃ“J URL Z /exec === */
  const API_URL = 'https://script.google.com/macros/s/AKfycbzWPygueePL-z1re__YROKMhY_mgiIbKp64mVdDgvovjBb5jxTe3RjgISQUEVbHZnvGVQ/exec';

  /* === profil (nick + PIN -> ownerId) === */
  const OWNER_KEY='utopia_owner_v1';
  let OWNER = loadOwner();
  function loadOwner(){ try{return JSON.parse(localStorage.getItem(OWNER_KEY)||'null')}catch(e){return null} }
  async function deriveOwnerId(nick, pin){
    const enc = new TextEncoder();
    const salt = enc.encode('salt:'+nick+':utopia-pepper-v1');
    const keyMat = await crypto.subtle.importKey('raw', enc.encode(pin),'PBKDF2',false,['deriveBits']);
    const bits = await crypto.subtle.deriveBits({name:'PBKDF2',hash:'SHA-256',salt,iterations:100000}, keyMat, 256);
    return btoa(String.fromCharCode(...new Uint8Array(bits)));
  }
  async function saveOwner(nick,pin){
    const ownerId = await deriveOwnerId(nick,pin);
    OWNER = {nick, ownerId};
    localStorage.setItem(OWNER_KEY, JSON.stringify(OWNER));
  }
  const profEl=document.getElementById('profile'), pSave=document.getElementById('pSave'), pErr=document.getElementById('pErr'), nickSet=document.getElementById('nickSet'), pinSet=document.getElementById('pinSet');
  if(!OWNER){ profEl.classList.add('open'); }
  pSave.addEventListener('click', async ()=>{
    const n=(nickSet.value||'').trim(), p=(pinSet.value||'').trim();
    if(n.length<2||p.length<4){ pErr.textContent='Podaj nick i PIN (min. 4 cyfry).'; return; }
    await saveOwner(n,p); profEl.classList.remove('open'); loadAndRender();
  });

  /* === API === */
  async function apiList(){ const r = await fetch(API_URL+'?action=list'); return r.json(); }
  async function apiAdd(offer, blob){
    const imgData = blob ? await blobToDataURL(blob) : '';
    const body = JSON.stringify({ action:'add', ...offer, imgData });
    const r = await fetch(API_URL, { method:'POST', headers:{ 'Content-Type':'text/plain; charset=utf-8' }, body });
    const text = await r.text(); try { return JSON.parse(text); } catch { return {ok:false, error:`HTTP ${r.status} ${text.slice(0,120)}`}; }
  }
  async function apiDelete(id, typedPin, isOwner){
    const ownerIdTry = (isOwner && OWNER) ? await deriveOwnerId(OWNER.nick, typedPin) : '';
    const body = JSON.stringify({ action:'delete', id, pin:typedPin, ownerIdTry });
    const r = await fetch(API_URL, { method:'POST', headers:{ 'Content-Type':'text/plain; charset=utf-8' }, body });
    const text = await r.text(); try { return JSON.parse(text); } catch { return {ok:false, error:`HTTP ${r.status} ${text.slice(0,120)}`}; }
  }
  function blobToDataURL(blob){ return new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(blob); }); }

  /* === UI / lista === */
  let REMOTE=[];
  const tabs=document.querySelectorAll('.tab');
  const minEl=document.getElementById('minLvl'), maxEl=document.getElementById('maxLvl'), tbody=document.getElementById('tbody'), empty=document.getElementById('empty'), previewImg=document.getElementById('pImg');
  const state={type:'Wszystkie',min:'',max:''};

  tabs.forEach(b=>b.addEventListener('click',()=>{state.type=b.dataset.type;tabs.forEach(t=>t.setAttribute('aria-selected',String(t===b)));render()}));
  document.getElementById('searchBtn').addEventListener('click',()=>{state.min=minEl.value?+minEl.value:'';state.max=maxEl.value?+maxEl.value:'';render()});
  document.getElementById('resetBtn').addEventListener('click',()=>{minEl.value=maxEl.value='';state.min=state.max='';state.type='Wszystkie';tabs.forEach(t=>t.setAttribute('aria-selected',t.dataset.type==='Wszystkie'));render()});

  function typeMatches(t){ if(state.type==='Wszystkie') return true; if(state.type==='Inny') return t==='Inny'||t==='Inne'; return t===state.type; }
  function byFilters(x){ if(!typeMatches(x.type)) return false; if(state.min!=='' && x.lvl<state.min) return false; if(state.max!=='' && x.lvl>state.max) return false; return true; }

  async function loadAndRender(){ REMOTE = await apiList(); render(); }
  function render(){
    const data = REMOTE.filter(byFilters).sort((a,b)=>a.lvl-b.lvl || a.type.localeCompare(b.type));
    tbody.innerHTML=''; if(!data.length){ empty.hidden=false; setPreviewEmpty(); return } else empty.hidden=true;
    for(const it of data){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><span class="badge">${it.lvl}</span></td>
        <td><div style="display:flex;align-items:center;gap:10px"><img class="thumb" alt="miniatura" src="${it.imgUrl||''}"><div style="font-size:12px;color:#aeb6c7">${it.type}</div></div></td>
        <td>${it.price}</td>
        <td><a href="#" title="Kopiuj kontakt">${it.contact}</a></td>
        <td><button class="xbtn" title="UsuÅ„ ofertÄ™">âœ•</button></td>`;
      tr.querySelector('a').addEventListener('click',e=>{e.preventDefault();navigator.clipboard.writeText(it.contact);});
      tr.addEventListener('click',e=>{ if(e.target.closest('.xbtn')) return; show(it); });
      tr.querySelector('.xbtn').addEventListener('click',()=> askDelete(it));
      tbody.appendChild(tr);
    }
    if(data[0]) show(data[0]); else setPreviewEmpty();
  }
  function setPreviewEmpty(){
    previewImg.src='';
    document.getElementById('pMeta').innerHTML=`<div>Typ: <b>â€”</b></div><div>LVL: <b>â€”</b></div><div>Cena: <b>â€”</b></div><div>Kontakt: <b>â€”</b></div>`;
  }
  function show(it){
    previewImg.src = it.imgUrl||'';
    document.getElementById('pMeta').innerHTML =
      `<div>Typ: <b>${it.type}</b></div><div>LVL: <b>${it.lvl}</b></div><div>Cena: <b>${it.price}</b></div><div>Kontakt: <b>${it.contact}</b></div>`;
  }

  /* === Dodawanie === */
  const overlay=document.getElementById('overlay'), addBtn=document.getElementById('addBtn'), closeBtn=document.getElementById('closeBtn'), saveBtn=document.getElementById('saveBtn'), hint=document.getElementById('formHint');
  const drop=document.getElementById('drop'), dropImg=document.getElementById('dropImg'), dropHint=document.getElementById('dropHint'), imgFile=document.getElementById('imgFile');
  const lvlIn=document.getElementById('lvlIn'), typeIn=document.getElementById('typeIn'), priceIn=document.getElementById('priceIn'), contactIn=document.getElementById('contactIn');
  let imageBlob=null;

  function openModal(){ if(!OWNER){ profEl.classList.add('open'); return } overlay.classList.add('open'); hint.textContent=''; saveBtn.disabled=false; drop.focus(); }
  function closeModal(){ overlay.classList.remove('open'); resetForm(); }
  function resetForm(){ [lvlIn,priceIn,contactIn].forEach(i=>i.value=''); typeIn.value='Legendarny'; imageBlob=null; dropImg.style.display='none'; dropHint.style.display='block'; }
  addBtn.addEventListener('click',openModal); closeBtn.addEventListener('click',closeModal);
  overlay.addEventListener('click',e=>{if(e.target===overlay) closeModal()}); document.addEventListener('keydown',e=>{if(overlay.classList.contains('open')&&e.key==='Escape') closeModal()});

  ;['dragenter','dragover','dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{e.preventDefault();e.stopPropagation()}));
  ;['dragenter','dragover'].forEach(()=> drop.classList.add('drag')); ['dragleave','drop'].forEach(()=> drop.classList.remove('drag'));
  drop.addEventListener('click',()=>imgFile.click());
  drop.addEventListener('drop',e=> handleFiles(e.dataTransfer.files));
  imgFile.addEventListener('change',()=>handleFiles(imgFile.files));
  document.addEventListener('paste',e=>{
    if(!overlay.classList.contains('open')) return;
    const items=e.clipboardData&&e.clipboardData.items; if(!items) return;
    for(const it of items){ if(it.type&&it.type.startsWith('image/')){ const f=it.getAsFile(); if(f) handleFile(f); break; } }
  });
  function handleFiles(list){ if(list&&list[0]) handleFile(list[0]) }
  function handleFile(file){
    if(!file.type.startsWith('image/')){ hint.textContent='To nie jest obraz.'; return }
    const reader=new FileReader();
    reader.onload = ev => compressToMax(ev.target.result,800,blob=>{ imageBlob=blob; dropImg.src=URL.createObjectURL(blob); dropImg.style.display='block'; dropHint.style.display='none'; });
    reader.readAsDataURL(file);
  }
  function compressToMax(dataUrl,max,cb){ const img=new Image(); img.onload=()=>{ const s=Math.min(1,max/Math.max(img.width,img.height)); const w=Math.round(img.width*s),h=Math.round(img.height*s); const c=document.createElement('canvas'); c.width=w;c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); c.toBlob(b=>cb(b),'image/png',0.95); }; img.src=dataUrl; }

  saveBtn.addEventListener('click', async ()=>{
    if(!OWNER){ profEl.classList.add('open'); return }
    const lvl=parseInt(lvlIn.value,10), type=typeIn.value, price=(priceIn.value||'').trim(), contact=(contactIn.value||'').trim();
    if(!lvl||!price||!contact){ hint.textContent='UzupeÅ‚nij: lvl, cena, kontakt.'; return }
    saveBtn.disabled=true;
    const offer = { type, lvl, price, contact, ownerId: OWNER.ownerId };
    const res = await apiAdd(offer, imageBlob).catch(()=>({ok:false}));
    saveBtn.disabled=false;
    if(!res.ok){ hint.textContent = 'BÅ‚Ä…d zapisu: ' + (res.error || 'sprÃ³buj ponownie.'); return }
    closeModal(); await loadAndRender();
  });

  /* === Usuwanie === */
  const confirmEl=document.getElementById('confirm'), cYes=document.getElementById('cYes'), cNo=document.getElementById('cNo'), cErr=document.getElementById('cErr'), pinConfirm=document.getElementById('pinConfirm');
  function askDelete(item){
    confirmEl.classList.add('open'); cErr.textContent=''; pinConfirm.value=''; pinConfirm.focus();
    const isOwner = !!(OWNER && item.ownerId && OWNER.ownerId===item.ownerId);
    const onNo = ()=> cleanup(); const onYes = async ()=>{
      const pin=(pinConfirm.value||'').trim(); if(!pin){ cErr.textContent='Wpisz PIN.'; return }
      const res = await apiDelete(item.id, pin, isOwner).catch(()=>({ok:false}));
      if(!res.ok){ cErr.textContent = res.error || 'BÅ‚Ä…d operacji.'; return }
      cleanup(); await loadAndRender();
    };
    function cleanup(){ cNo.removeEventListener('click',onNo); cYes.removeEventListener('click',onYes); confirmEl.classList.remove('open'); }
    cNo.addEventListener('click',onNo); cYes.addEventListener('click',onYes);
    document.addEventListener('keydown',function esc(e){ if(e.key==='Escape'){ cleanup(); document.removeEventListener('keydown',esc);} });
  }

  /* start */
  async function start(){ if(OWNER) await loadAndRender(); else render(); }
  start();
</script>
</body>
</html>
