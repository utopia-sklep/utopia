<!doctype html>
<html lang="pl" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Utopia sprzedaje</title>
<link href="https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css" rel="stylesheet">
<style>
  /* === LOCK THEME & PALETTE === */
  html { color-scheme: dark; }
  :root { --gold:#d4b86a; --gold-b:#d4b86a73; }

  /* Tło + kolor treści (niezależnie od pico) */
  body { background:#0f1217; color:#e6e6e6; }

  /* Ramki w całej aplikacji – jedna złota paleta */
  header, .card, dialog, input, select, button, table {
    border-color: var(--gold-b) !important;
  }

  /* Header i „card” z własnym tłem (pico przestanie ich rozjaśniać) */
  header {
    margin:1rem auto; max-width:1200px;
    border:1px solid var(--gold);
    border-radius:10px; padding:12px 14px;
    background:#0f1217;
  }
  .card {
    background:#0f1217; border:1px solid var(--gold);
    border-radius:10px;
  }

  /* Wyrównanie i drobne utilsy */
  .toolbar { display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
  .push-right { margin-left:auto; }

  /* Chipy filtrów */
  .chip {
    background:#171a21; border:1px solid var(--gold-b);
    padding:.45rem .8rem; border-radius:.7rem; cursor:pointer;
  }
  .chip.active { background:#1f242e; outline:1px solid var(--gold); }

  /* Layout */
  .grid { max-width:1200px; margin:0 auto 80px; }

  /* Tabela – całkowicie ciemna, bez białych teł pico */
  table { width:100%; border-collapse:separate; border-spacing:0;
          border:1px solid var(--gold-b); border-radius:12px; overflow:hidden;
          background:transparent; }
  thead { background:#141924; }
  th,td { border-bottom:1px solid rgba(212,184,106,.15); background:transparent; }

  td img.item {
    width:52px; height:52px; object-fit:cover; border-radius:8px;
    border:1px solid rgba(212,184,106,.35); background:#0b0e12;
  }
  td .lvl {
    display:inline-grid; place-items:center; width:32px; height:32px;
    border:1px solid var(--gold-b); border-radius:999px;
  }
  td .acts { display:flex; gap:.4rem; justify-content:flex-end; }
  .muted { opacity:.7; }

  /* Modale */
  dialog { max-width:980px; background:#0f1217; }
  .drop {
    min-height:260px; border:2px dashed var(--gold-b);
    border-radius:12px; display:grid; place-items:center; color:#cfcfcf; background:#0b0e12;
  }
  .drop.drag { outline:2px solid var(--gold); }
  .hint { min-height:1.25rem; color:#f6c177; }

  /* Admin box */
  .admin-box { position:fixed; right:14px; bottom:14px; display:flex; gap:.5rem; }
  .admin-box button { border-color: var(--gold-b) !important; }
</style>
</head>
<body>

<header>
  <div class="toolbar">
    <span class="chip type chip-type" data-type="Legendarny">Legendarny</span>
    <span class="chip type chip-type" data-type="Heroiczny">Heroiczny</span>
    <span class="chip type chip-type" data-type="Unikatowy">Unikatowy</span>
    <span class="chip type chip-type" data-type="Inny">Inny</span>
    <span class="chip type chip-type active" data-type="Wszystkie">Wszystkie</span>

    <input id="minLvl" type="number" placeholder="min. lvl" style="width:120px">
    <input id="maxLvl" type="number" placeholder="max. lvl" style="width:120px">
    <button id="btnSearch">szukaj</button>
    <button id="btnReset" class="secondary">reset</button>

    <div class="push-right"></div>
    <button id="btnMine" class="chip">Twoje oferty</button>
    <button id="btnAll" class="chip active">Wszystkie oferty</button>
    <button id="btnSettings" class="secondary">Zmień ustawienia</button>
    <button id="btnAdd" class="contrast">+ Dodaj ofertę</button>
  </div>
</header>

<main class="grid">
  <article class="card">
    <table>
      <thead>
        <tr>
          <th style="width:80px">LVL</th>
          <th>PRZEDMIOT</th>
          <th style="width:100px">ILOŚĆ</th>
          <th style="width:140px">CENA</th>
          <th style="width:260px">KONTAKT DC.</th>
          <th style="width:110px"></th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </article>
</main>

<!-- MODAL: add/edit -->
<dialog id="dlg">
  <article>
    <header>
      <strong id="dlgTitle">Dodawanie oferty</strong>
      <a href="#" id="dlgClose" aria-label="Zamknij" class="close"></a>
    </header>

    <div class="grid" style="grid-template-columns: 1fr 1fr; gap:16px">
      <div>
        <div id="drop" class="drop">
          <div>
            <h5 style="margin:0 0 6px">Dodaj zdjęcie</h5>
            <p class="muted" style="margin:0">Przeciągnij plik, <u>wklej (Ctrl+V)</u> lub kliknij (PNG/JPG)</p>
          </div>
          <input id="file" type="file" accept="image/png,image/jpeg" hidden>
        </div>
        <small class="muted">Obraz zostanie skompresowany do ~800 px i wysłany do serwera.</small>
      </div>

      <div>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px">
          <input id="fLvl" type="number" placeholder="lvl (np. 93)">
          <select id="fType">
            <option>Legendarny</option>
            <option>Heroiczny</option>
            <option>Unikatowy</option>
            <option>Inny</option>
          </select>
          <input id="fPrice" placeholder="cena (np. 500m)">
          <input id="fContact" placeholder="kontakt (np. @twojNick)">
        </div>

        <label style="margin-top:10px">
          <input id="fMany" type="checkbox"> Więcej niż jeden
        </label>
        <input id="fQty" type="number" placeholder="ilość" style="max-width:160px; display:none">

        <div id="dlgHint" class="hint"></div>
        <footer>
          <button id="btnSave" class="contrast">Zapisz</button>
          <button id="btnCancel" class="secondary">Anuluj</button>
        </footer>
      </div>
    </div>
  </article>
</dialog>

<!-- MODAL: settings -->
<dialog id="set">
  <article>
    <header>
      <strong>Ustawienia profilu</strong>
      <a href="#" id="setClose" aria-label="Zamknij" class="close"></a>
    </header>
    <label>Nick na Discordzie
      <input id="sNick" placeholder="@twójNick">
    </label>
    <label>PIN (4 cyfry)
      <input id="sPin" type="password" inputmode="numeric" minlength="4" maxlength="4" placeholder="****">
    </label>
    <div class="hint" id="setHint"></div>
    <footer>
      <button id="btnSetSave" class="contrast">Zapisz</button>
      <button id="btnSetCancel" class="secondary">Anuluj</button>
    </footer>
  </article>
</dialog>

<!-- ADMIN -->
<div class="admin-box">
  <button id="btnAdminLogin">Zaloguj admina</button>
  <button id="btnAdminLogout" class="secondary">Wyloguj admina</button>
</div>

<script>
/* === ADRES API (TWÓJ) === */
const API_URL = 'https://script.google.com/macros/s/AKfycbz3W6jwL5Ab1PBw_jjvhsAlXz0OtyCYHLQvSdO97RqXm7ZKuYW8wXeKAeJUYaKW-kjARQ/exec';

/* === stan === */
let ITEMS = [];
let FILTER = { type: 'Wszystkie', mine: false, min: null, max: null };
let CURRENT = null; // edytowana oferta
const rowsEl = document.getElementById('rows');

/* === utils === */
const b64 = s => {
  const enc = new TextEncoder().encode(s);
  return window.crypto.subtle.digest('SHA-256', enc).then(buf => {
    const bytes = Array.from(new Uint8Array(buf));
    const bin = String.fromCharCode.apply(null, bytes);
    return btoa(bin);
  });
};
async function ownerFromLocal() {
  const raw = localStorage.getItem('utopia_owner_v1');
  if (!raw) return null;
  try { return JSON.parse(raw); } catch(e){ return null; }
}
async function requireOwner() {
  const me = await ownerFromLocal();
  if (!me) { document.getElementById('set').showModal(); throw new Error('profile_missing'); }
  return me;
}
function adminToken() {
  return localStorage.getItem('utopia_admin_token_v1') || '';
}

/* === API === */
async function apiList(){ return fetch(API_URL+'?action=list').then(r=>r.json()); }
async function apiAdd(offer, imageBlob){
  const imgData = imageBlob ? await blobToDataURL(imageBlob) : '';
  return fetch(API_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action:'add', ...offer, imgData })
  }).then(r=>r.json());
}
async function apiUpdate(id, fields, imageBlob){
  const me = await ownerFromLocal();
  const imgData = imageBlob ? await blobToDataURL(imageBlob) : '';
  return fetch(API_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      action:'update', id,
      ...fields,
      imgData,
      ownerIdTry: me?.ownerId || '',
      adminToken: adminToken()
    })
  }).then(r=>r.json());
}
async function apiDelete(id){
  const me = await ownerFromLocal();
  return fetch(API_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      action:'delete', id,
      ownerIdTry: me?.ownerId || '',
      adminToken: adminToken()
    })
  }).then(r=>r.json());
}

/* === obraz === */
function blobToDataURL(blob){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(blob);
  });
}
function compressImage(fileOrBlob, max = 800){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.onload = ()=>{
      const scale = Math.max(img.width, img.height) > max ? max/Math.max(img.width, img.height) : 1;
      const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
      const cv = document.createElement('canvas'); cv.width = w; cv.height = h;
      const cx = cv.getContext('2d'); cx.drawImage(img,0,0,w,h);
      cv.toBlob(b=> resolve(b), 'image/jpeg', .9);
    };
    img.onerror = reject;
    const url = URL.createObjectURL(fileOrBlob);
    img.src = url;
  });
}

/* === render === */
function render(){
  const meToken = adminToken();
  const meOwner = localStorage.getItem('utopia_owner_v1');
  const me = meOwner ? JSON.parse(meOwner) : null;

  let list = ITEMS.slice();
  if (FILTER.type && FILTER.type !== 'Wszystkie') list = list.filter(x => x.type === FILTER.type);
  if (FILTER.mine && me) list = list.filter(x => x.ownerId === me.ownerId);
  if (FILTER.min != null) list = list.filter(x => x.lvl >= FILTER.min);
  if (FILTER.max != null) list = list.filter(x => x.lvl <= FILTER.max);

  rowsEl.innerHTML = '';
  for (const it of list){
    const tr = document.createElement('tr');

    const tdLvl = document.createElement('td');
    tdLvl.innerHTML = `<span class="lvl">${it.lvl}</span>`;
    tr.appendChild(tdLvl);

    const tdItem = document.createElement('td');
    tdItem.innerHTML = `<img class="item" src="${it.imgUrl||''}" alt="miniatura" onerror="this.style.visibility='hidden'"> 
                        <div class="muted" style="display:inline-block; margin-left:.6rem">${it.type}</div>`;
    tr.appendChild(tdItem);

    const tdQty = document.createElement('td');
    tdQty.textContent = it.qty ? it.qty : '';
    tr.appendChild(tdQty);

    const tdPrice = document.createElement('td');
    tdPrice.textContent = it.price || '';
    tr.appendChild(tdPrice);

    const tdContact = document.createElement('td');
    tdContact.textContent = it.contact || '';
    tr.appendChild(tdContact);

    const tdActs = document.createElement('td');
    tdActs.className = 'acts';
    const canEdit = (me && it.ownerId === me.ownerId) || !!meToken;
    if (canEdit){
      const bEdit = document.createElement('button');
      bEdit.innerHTML = '✎';
      bEdit.title = 'Edytuj';
      bEdit.onclick = ()=> openEdit(it);
      const bDel = document.createElement('button');
      bDel.innerHTML = '✕';
      bDel.title = 'Usuń';
      bDel.onclick = ()=> onDelete(it);
      tdActs.append(bEdit,bDel);
    }
    tr.appendChild(tdActs);

    rowsEl.appendChild(tr);
  }
}

/* === pobieranie === */
async function load(){
  const list = await apiList();
  ITEMS = list;
  render();
}

/* === filtry === */
document.querySelectorAll('.chip-type').forEach(el=>{
  el.addEventListener('click', ()=>{
    document.querySelectorAll('.chip-type').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
    FILTER.type = el.dataset.type;
    render();
  });
});
document.getElementById('btnSearch').onclick = ()=>{
  const min = document.getElementById('minLvl').valueAsNumber;
  const max = document.getElementById('maxLvl').valueAsNumber;
  FILTER.min = Number.isFinite(min)?min:null;
  FILTER.max = Number.isFinite(max)?max:null;
  render();
};
document.getElementById('btnReset').onclick = ()=>{
  document.getElementById('minLvl').value = '';
  document.getElementById('maxLvl').value = '';
  FILTER.min = FILTER.max = null;
  render();
};
document.getElementById('btnMine').onclick = ()=>{
  FILTER.mine = true;
  document.getElementById('btnMine').classList.add('active');
  document.getElementById('btnAll').classList.remove('active');
  render();
};
document.getElementById('btnAll').onclick = ()=>{
  FILTER.mine = false;
  document.getElementById('btnAll').classList.add('active');
  document.getElementById('btnMine').classList.remove('active');
  render();
};

/* === add/edit modal === */
const dlg = document.getElementById('dlg');
const drop = document.getElementById('drop');
const file = document.getElementById('file');
const hint = document.getElementById('dlgHint');
let IMAGE_BLOB = null;

function clearDialog(){
  document.getElementById('dlgTitle').textContent = 'Dodawanie oferty';
  document.getElementById('fLvl').value = '';
  document.getElementById('fType').value = 'Legendarny';
  document.getElementById('fPrice').value = '';
  document.getElementById('fContact').value = '';
  document.getElementById('fMany').checked = false;
  document.getElementById('fQty').style.display = 'none';
  document.getElementById('fQty').value = '';
  IMAGE_BLOB = null;
  hint.textContent = '';
}
document.getElementById('fMany').onchange = (e)=>{
  document.getElementById('fQty').style.display = e.target.checked ? 'block' : 'none';
};

function openAdd(){
  CURRENT = null;
  clearDialog();
  dlg.showModal();
}
function openEdit(it){
  CURRENT = it;
  clearDialog();
  document.getElementById('dlgTitle').textContent = 'Edytuj ofertę';
  document.getElementById('fLvl').value = it.lvl;
  document.getElementById('fType').value = it.type;
  document.getElementById('fPrice').value = it.price || '';
  document.getElementById('fContact').value = it.contact || '';
  if (it.qty && Number(it.qty) > 1) {
    document.getElementById('fMany').checked = true;
    document.getElementById('fQty').style.display = 'block';
    document.getElementById('fQty').value = it.qty;
  }
  dlg.showModal();
}

/* drop/paste */
drop.addEventListener('click', ()=> file.click());
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
drop.addEventListener('drop', async e=>{
  e.preventDefault(); drop.classList.remove('drag');
  const f = e.dataTransfer.files?.[0]; if (!f) return;
  IMAGE_BLOB = await compressImage(f);
});
file.addEventListener('change', async e=>{
  const f = e.target.files?.[0]; if (!f) return;
  IMAGE_BLOB = await compressImage(f);
});
window.addEventListener('paste', async e=>{
  if (!dlg.open) return;
  const item = [...e.clipboardData.items].find(i=> i.type.startsWith('image/'));
  if (!item) return;
  const blob = item.getAsFile();
  IMAGE_BLOB = await compressImage(blob);
});

/* zapisz/usuń */
document.getElementById('btnAdd').onclick = ()=> openAdd();
document.getElementById('btnCancel').onclick = ()=> dlg.close();
document.getElementById('dlgClose').onclick = (e)=>{ e.preventDefault(); dlg.close(); };

document.getElementById('btnSave').onclick = async ()=>{
  try {
    const me = await requireOwner();
    const lvl = Number(document.getElementById('fLvl').value || 0);
    const type = document.getElementById('fType').value;
    const price = document.getElementById('fPrice').value.trim();
    const contact = document.getElementById('fContact').value.trim();
    const many = document.getElementById('fMany').checked;
    const qty = many ? Math.max(2, Number(document.getElementById('fQty').value||2)) : 1;

    if (!lvl) { hint.textContent='Podaj poziom.'; return; }
    if (!IMAGE_BLOB && !CURRENT) { hint.textContent='Dodaj obraz.'; return; }

    if (!CURRENT){
      // ADD
      const offer = { type, lvl, price, qty, contact, ownerId: me.ownerId };
      const res = await apiAdd(offer, IMAGE_BLOB);
      if (!res.ok) { hint.textContent = 'Błąd zapisu: ' + (res.error||'spróbuj ponownie.'); return; }
    } else {
      // UPDATE
      const fields = { type, lvl, price, qty, contact };
      const res = await apiUpdate(CURRENT.id, fields, IMAGE_BLOB);
      if (!res.ok) { hint.textContent = 'Błąd edycji: ' + (res.error||'spróbuj ponownie.'); return; }
    }
    dlg.close();
    await load();
  } catch(err){
    if (err.message==='profile_missing'){ hint.textContent='Ustaw najpierw nick i PIN w „Zmień ustawienia”.'; }
    else { hint.textContent='Błąd: '+err.message; }
  }
};

async function onDelete(it){
  if (!confirm('Czy na pewno chcesz zamknąć ofertę?')) return;
  const res = await apiDelete(it.id);
  if (!res.ok){ alert(res.error || 'Błąd operacji.'); return; }
  await load();
}

/* === ustawienia === */
const setDlg = document.getElementById('set');
document.getElementById('btnSettings').onclick = async ()=>{
  const me = await ownerFromLocal();
  document.getElementById('sNick').value = me?.nick || '';
  document.getElementById('sPin').value = '';
  document.getElementById('setHint').textContent='';
  setDlg.showModal();
};
document.getElementById('btnSetCancel').onclick = ()=> setDlg.close();
document.getElementById('setClose').onclick = (e)=>{ e.preventDefault(); setDlg.close(); };

document.getElementById('btnSetSave').onclick = async ()=>{
  const nick = document.getElementById('sNick').value.trim();
  const pin  = document.getElementById('sPin').value.trim();
  if (!nick || !/^\d{4}$/.test(pin)){
    document.getElementById('setHint').textContent = 'Podaj nick i 4-cyfrowy PIN.';
    return;
  }
  const ownerId = await b64(`${nick}|${pin}`);
  localStorage.setItem('utopia_owner_v1', JSON.stringify({ nick, ownerId }));
  document.getElementById('setHint').textContent = 'Zapisano.';
  setTimeout(()=> setDlg.close(), 400);
  render();
};

/* === admin === */
document.getElementById('btnAdminLogin').onclick = async ()=>{
  const pwd = prompt('Hasło administratora:');
  if (!pwd) return;
  const token = await b64(pwd);
  localStorage.setItem('utopia_admin_token_v1', token);
  alert('Zalogowano admina (lokalnie).');
  render();
};
document.getElementById('btnAdminLogout').onclick = ()=>{
  localStorage.removeItem('utopia_admin_token_v1');
  alert('Wylogowano admina.');
  render();
};

/* start */
load();
</script>
</body>
</html>
