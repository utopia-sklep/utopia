<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Utopia sprzedaje</title>

  <!-- Pico CSS (pin + fallback) -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2.0.6/css/pico.min.css">
  <script>
    // Fallback na wypadek problemów z CDN
    (function(){
      addEventListener('load', function(){
        var ok = Array.from(document.styleSheets).some(s => (s.href||'').includes('@picocss'));
        if (!ok) {
          var l = document.createElement('link');
          l.rel = 'stylesheet';
          l.href = 'https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css';
          document.head.appendChild(l);
        }
      });
    })();
  </script>

  <!-- Bazowe style (stabilny układ nawet bez Pico) -->
  <style>
    :root { --gold:#d4b86a; }
    *{ box-sizing:border-box }
    body{ background:#0f1217; color:#e6e6e6 }
    a{ color:#f0d999 }
    header{ margin:1rem auto; max-width:1200px; border:1px solid rgba(212,184,106,.45); border-radius:10px; padding:12px 14px; background:#0f1217 }
    .toolbar{ display:flex; gap:.6rem; flex-wrap:wrap; align-items:center }
    .push-right{ margin-left:auto }
    .chip{ background:#171a21; border:1px solid rgba(212,184,106,.45); padding:.45rem .8rem; border-radius:.7rem; cursor:pointer; user-select:none }
    .chip.active{ background:#1f242e; outline:1px solid var(--gold) }
    .grid{ max-width:1200px; margin:0 auto 80px }
    table{ width:100%; border:1px solid rgba(212,184,106,.45); border-radius:12px; border-collapse:separate; border-spacing:0; overflow:hidden; background:#0f1217 }
    thead{ background:#141924 }
    th,td{ border-bottom:1px solid rgba(212,184,106,.15) }
    td img.item{ width:52px; height:52px; object-fit:cover; border-radius:8px; border:1px solid rgba(212,184,106,.35); background:#0b0e12 }
    td .lvl{ display:inline-grid; place-items:center; width:32px; height:32px; border:1px solid rgba(212,184,106,.45); border-radius:999px }
    td .acts{ display:flex; gap:.4rem; justify-content:flex-end }
    .muted{ opacity:.75 }
    dialog{ background:#0f1217; color:#e6e6e6; border:1px solid rgba(212,184,106,.45) }
    .drop{ min-height:260px; border:2px dashed rgba(212,184,106,.45); border-radius:12px; display:grid; place-items:center; color:#cfcfcf; background:#0b0e12; padding:12px; text-align:center }
    .drop.drag{ outline:2px solid var(--gold) }
    .hint{ min-height:1.2rem; color:#f6c177 }
    .admin-box{ position:fixed; right:14px; bottom:14px; display:flex; gap:.5rem }
    .admin-box button{ border-color:rgba(212,184,106,.45)!important }
    /* Inputs w headerze */
    header input[type=number]{ width:120px; min-width:100px }
  </style>
</head>
<body>

<header>
  <div class="toolbar">
    <!-- typy -->
    <span class="chip type" data-type="Legendarny">Legendarny</span>
    <span class="chip type" data-type="Heroiczny">Heroiczny</span>
    <span class="chip type" data-type="Unikatowy">Unikatowy</span>
    <span class="chip type" data-type="Inny">Inny</span>
    <span class="chip type active" data-type="Wszystkie">Wszystkie</span>

    <!-- filtry lvl -->
    <input id="minLvl" type="number" placeholder="min. lvl">
    <input id="maxLvl" type="number" placeholder="max. lvl">
    <button id="btnSearch">szukaj</button>
    <button id="btnReset" class="secondary">reset</button>

    <div class="push-right"></div>

    <!-- widok -->
    <button id="btnMine" class="chip">Twoje oferty</button>
    <button id="btnAll" class="chip active">Wszystkie oferty</button>

    <!-- akcje -->
    <button id="btnSettings" class="secondary">Zmień ustawienia</button>
    <button id="btnAdd" class="contrast">+ Dodaj ofertę</button>
  </div>
</header>

<main class="grid">
  <article class="card">
    <table>
      <thead>
        <tr>
          <th style="width:80px">LVL</th>
          <th>PRZEDMIOT</th>
          <th style="width:100px">ILOŚĆ</th>
          <th style="width:140px">CENA</th>
          <th style="width:260px">KONTAKT DC.</th>
          <th style="width:110px"></th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </article>
</main>

<!-- MODAL: dodawanie / edycja -->
<dialog id="dlg">
  <article>
    <header>
      <strong id="dlgTitle">Dodawanie oferty</strong>
      <a href="#" id="dlgClose" aria-label="Zamknij" class="close"></a>
    </header>

    <div class="grid" style="grid-template-columns: 1fr 1fr; gap:16px">
      <div>
        <div id="drop" class="drop">
          <div>
            <h5 style="margin:0 0 6px">Dodaj zdjęcie</h5>
            <p class="muted" style="margin:0">Przeciągnij plik, <u>wklej (Ctrl+V)</u> lub kliknij (PNG/JPG)</p>
          </div>
          <input id="file" type="file" accept="image/png,image/jpeg" hidden>
        </div>
        <small class="muted">Obraz kompresujemy lokalnie do ~800 px i wysyłamy do serwera.</small>
      </div>

      <div>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px">
          <input id="fLvl" type="number" placeholder="lvl (np. 93)">
          <select id="fType">
            <option>Legendarny</option>
            <option>Heroiczny</option>
            <option>Unikatowy</option>
            <option>Inny</option>
          </select>
          <input id="fPrice" placeholder="cena (np. 500m)">
          <input id="fContact" placeholder="kontakt (np. @twojNick)">
        </div>

        <label style="margin-top:10px">
          <input id="fMany" type="checkbox"> Więcej niż jeden
        </label>
        <input id="fQty" type="number" placeholder="ilość" style="max-width:160px; display:none">

        <div id="dlgHint" class="hint"></div>
        <footer>
          <button id="btnSave" class="contrast">Zapisz</button>
          <button id="btnCancel" class="secondary">Anuluj</button>
        </footer>
      </div>
    </div>
  </article>
</dialog>

<!-- MODAL: ustawienia profilu -->
<dialog id="set">
  <article>
    <header>
      <strong>Ustawienia profilu</strong>
      <a href="#" id="setClose" aria-label="Zamknij" class="close"></a>
    </header>
    <label>Nick na Discordzie
      <input id="sNick" placeholder="@twójNick">
    </label>
    <label>PIN (4 cyfry)
      <input id="sPin" type="password" inputmode="numeric" minlength="4" maxlength="4" placeholder="****">
    </label>
    <div class="hint" id="setHint"></div>
    <footer>
      <button id="btnSetSave" class="contrast">Zapisz</button>
      <button id="btnSetCancel" class="secondary">Anuluj</button>
    </footer>
  </article>
</dialog>

<!-- ADMIN -->
<div class="admin-box">
  <button id="btnAdminLogin">Zaloguj admina</button>
  <button id="btnAdminLogout" class="secondary">Wyloguj admina</button>
</div>

<script>
/* === USTAW SWÓJ BACKEND TUTAJ === */
const API_URL = 'https://script.google.com/macros/s/AKfycbz3W6jwL5Ab1PBw_jjvhsAlXz0OtyCYHLQvSdO97RqXm7ZKuYW8wXeKAeJUYaKW-kjARQ/exec';

/* === STAN === */
let ITEMS = [];
let FILTER = { type: 'Wszystkie', mine: false, min: null, max: null };
let CURRENT = null; // edytowana oferta

/* === UTILS === */
const rowsEl = document.getElementById('rows');

const sha256b64 = async (str) => {
  const enc = new TextEncoder();
  const buf = await crypto.subtle.digest('SHA-256', enc.encode(str));
  const bytes = Array.from(new Uint8Array(buf));
  return btoa(String.fromCharCode.apply(null, bytes));
};

async function getOwner(){
  try { return JSON.parse(localStorage.getItem('utopia_owner_v1')||'null'); } catch(e){ return null; }
}
function getAdminToken(){ return localStorage.getItem('utopia_admin_token_v1') || ''; }

function blobToDataURL(blob){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(blob);
  });
}
function compressToMax(fileOrBlob, max=800){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.onload = ()=>{
      const scale = Math.max(img.width, img.height) > max ? max/Math.max(img.width, img.height) : 1;
      const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
      const cv = document.createElement('canvas'); cv.width = w; cv.height = h;
      cv.getContext('2d').drawImage(img,0,0,w,h);
      cv.toBlob(b=> resolve(b), 'image/jpeg', .9);
    };
    img.onerror = reject;
    img.src = URL.createObjectURL(fileOrBlob);
  });
}

/* === API === */
async function apiList(){ return fetch(API_URL+'?action=list').then(r=>r.json()); }
async function apiAdd(offer, imageBlob){
  const imgData = imageBlob ? await blobToDataURL(imageBlob) : '';
  const res = await fetch(API_URL, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action:'add', ...offer, imgData })
  });
  return res.json();
}
async function apiUpdate(id, fields, imageBlob){
  const me = await getOwner();
  const imgData = imageBlob ? await blobToDataURL(imageBlob) : '';
  const res = await fetch(API_URL, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action:'update', id, ...fields, imgData,
                           ownerIdTry: me?.ownerId || '', adminToken: getAdminToken() })
  });
  return res.json();
}
async function apiDelete(id){
  const me = await getOwner();
  const res = await fetch(API_URL, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action:'delete', id,
                           ownerIdTry: me?.ownerId || '', adminToken: getAdminToken() })
  });
  return res.json();
}

/* === RENDER === */
function render(){
  const me = getOwner();
  const isAdmin = !!getAdminToken();

  let arr = ITEMS.slice();
  if (FILTER.type && FILTER.type !== 'Wszystkie') arr = arr.filter(x => x.type === FILTER.type);
  if (FILTER.mine && me) arr = arr.filter(x => x.ownerId === me.ownerId);
  if (FILTER.min != null) arr = arr.filter(x => x.lvl >= FILTER.min);
  if (FILTER.max != null) arr = arr.filter(x => x.lvl <= FILTER.max);

  rowsEl.innerHTML = '';
  for (const it of arr){
    const tr = document.createElement('tr');

    const tdLvl = document.createElement('td');
    tdLvl.innerHTML = `<span class="lvl">${it.lvl}</span>`;
    tr.appendChild(tdLvl);

    const tdItem = document.createElement('td');
    tdItem.innerHTML = `
      <img class="item" src="${it.imgUrl||''}" alt="miniatura" referrerpolicy="no-referrer"
           onerror="this.style.visibility='hidden'">
      <span class="muted" style="margin-left:.6rem">${it.type}</span>`;
    tr.appendChild(tdItem);

    const tdQty = document.createElement('td');
    tdQty.textContent = it.qty ? it.qty : '';
    tr.appendChild(tdQty);

    const tdPrice = document.createElement('td');
    tdPrice.textContent = it.price || '';
    tr.appendChild(tdPrice);

    const tdContact = document.createElement('td');
    tdContact.textContent = it.contact || '';
    tr.appendChild(tdContact);

    const tdActs = document.createElement('td');
    tdActs.className = 'acts';
    const canEdit = (me && it.ownerId === me.ownerId) || isAdmin;
    if (canEdit){
      const bEdit = document.createElement('button'); bEdit.innerHTML = '✎'; bEdit.title='Edytuj';
      const bDel  = document.createElement('button'); bDel.innerHTML  = '✕'; bDel.title='Usuń';
      bEdit.onclick = ()=> openEdit(it);
      bDel.onclick  = ()=> onDelete(it);
      tdActs.append(bEdit,bDel);
    }
    tr.appendChild(tdActs);
    rowsEl.appendChild(tr);
  }
}

async function load(){
  ITEMS = await apiList();
  render();
}

/* === FILTRY / PRZYCISKI === */
document.querySelectorAll('.chip.type').forEach(el=>{
  el.addEventListener('click', ()=>{
    document.querySelectorAll('.chip.type').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
    FILTER.type = el.dataset.type;
    render();
  });
});
document.getElementById('btnSearch').onclick = ()=>{
  const a = document.getElementById('minLvl').valueAsNumber;
  const b = document.getElementById('maxLvl').valueAsNumber;
  FILTER.min = Number.isFinite(a)?a:null;
  FILTER.max = Number.isFinite(b)?b:null;
  render();
};
document.getElementById('btnReset').onclick = ()=>{
  document.getElementById('minLvl').value='';
  document.getElementById('maxLvl').value='';
  FILTER.min = FILTER.max = null;
  render();
};
document.getElementById('btnMine').onclick = ()=>{
  FILTER.mine = true;
  document.getElementById('btnMine').classList.add('active');
  document.getElementById('btnAll').classList.remove('active');
  render();
};
document.getElementById('btnAll').onclick = ()=>{
  FILTER.mine = false;
  document.getElementById('btnAll').classList.add('active');
  document.getElementById('btnMine').classList.remove('active');
  render();
};

/* === MODAL ADD/EDIT === */
const dlg = document.getElementById('dlg');
const drop = document.getElementById('drop');
const file = document.getElementById('file');
const hint = document.getElementById('dlgHint');
let IMAGE_BLOB = null;

function clearDialog(){
  document.getElementById('dlgTitle').textContent = 'Dodawanie oferty';
  document.getElementById('fLvl').value = '';
  document.getElementById('fType').value = 'Legendarny';
  document.getElementById('fPrice').value = '';
  document.getElementById('fContact').value = '';
  document.getElementById('fMany').checked = false;
  document.getElementById('fQty').style.display = 'none';
  document.getElementById('fQty').value = '';
  IMAGE_BLOB = null;
  hint.textContent = '';
}
function openAdd(){ CURRENT=null; clearDialog(); dlg.showModal(); }
function openEdit(it){
  CURRENT = it;
  clearDialog();
  document.getElementById('dlgTitle').textContent = 'Edytuj ofertę';
  document.getElementById('fLvl').value = it.lvl;
  document.getElementById('fType').value = it.type;
  document.getElementById('fPrice').value = it.price || '';
  document.getElementById('fContact').value = it.contact || '';
  if (it.qty && Number(it.qty) > 1) {
    document.getElementById('fMany').checked = true;
    document.getElementById('fQty').style.display = 'block';
    document.getElementById('fQty').value = it.qty;
  }
  dlg.showModal();
}

document.getElementById('btnAdd').onclick = openAdd;
document.getElementById('btnCancel').onclick = ()=> dlg.close();
document.getElementById('dlgClose').onclick = (e)=>{ e.preventDefault(); dlg.close(); };

document.getElementById('fMany').onchange = (e)=>{
  document.getElementById('fQty').style.display = e.target.checked ? 'block' : 'none';
};

/* drop/paste */
drop.addEventListener('click', ()=> file.click());
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
drop.addEventListener('drop', async e=>{
  e.preventDefault(); drop.classList.remove('drag');
  const f = e.dataTransfer.files?.[0]; if (!f) return;
  IMAGE_BLOB = await compressToMax(f);
});
file.addEventListener('change', async e=>{
  const f = e.target.files?.[0]; if (!f) return;
  IMAGE_BLOB = await compressToMax(f);
});
window.addEventListener('paste', async e=>{
  if (!dlg.open) return;
  const it = [...e.clipboardData.items].find(i=> i.type && i.type.startsWith('image/'));
  if (!it) return;
  const blob = it.getAsFile();
  IMAGE_BLOB = await compressToMax(blob);
});

/* zapisz / usuń */
document.getElementById('btnSave').onclick = async ()=>{
  try{
    // profil wymagany
    let owner = await getOwner();
    if (!owner){
      document.getElementById('set').showModal();
      hint.textContent = 'Ustaw najpierw nick i PIN w „Zmień ustawienia”.';
      return;
    }
    const lvl = Number(document.getElementById('fLvl').value || 0);
    const type = document.getElementById('fType').value;
    const price = (document.getElementById('fPrice').value || '').trim();
    const contact = (document.getElementById('fContact').value || '').trim();
    const many = document.getElementById('fMany').checked;
    const qty = many ? Math.max(2, Number(document.getElementById('fQty').value || 2)) : 1;

    if (!lvl){ hint.textContent = 'Podaj poziom.'; return; }
    if (!IMAGE_BLOB && !CURRENT){ hint.textContent='Dodaj obraz.'; return; }

    if (!CURRENT){
      const offer = { type, lvl, price, qty, contact, ownerId: owner.ownerId };
      const res = await apiAdd(offer, IMAGE_BLOB);
      if (!res.ok){ hint.textContent = 'Błąd zapisu: ' + (res.error||'spróbuj ponownie.'); return; }
    } else {
      const fields = { type, lvl, price, qty, contact };
      const res = await apiUpdate(CURRENT.id, fields, IMAGE_BLOB);
      if (!res.ok){ hint.textContent = 'Błąd edycji: ' + (res.error||'spróbuj ponownie.'); return; }
    }
    dlg.close();
    await load();
  }catch(err){
    hint.textContent = 'Błąd: ' + (err?.message || err);
  }
};

async function onDelete(it){
  if (!confirm('Czy na pewno chcesz zamknąć ofertę?')) return;
  const res = await apiDelete(it.id);
  if (!res.ok){ alert(res.error || 'Błąd operacji.'); return; }
  await load();
}

/* === USTAWIENIA PROFILU === */
const setDlg = document.getElementById('set');
document.getElementById('btnSettings').onclick = async ()=>{
  const me = await getOwner();
  document.getElementById('sNick').value = me?.nick || '';
  document.getElementById('sPin').value = '';
  document.getElementById('setHint').textContent = '';
  setDlg.showModal();
};
document.getElementById('btnSetCancel').onclick = ()=> setDlg.close();
document.getElementById('setClose').onclick = (e)=>{ e.preventDefault(); setDlg.close(); };

document.getElementById('btnSetSave').onclick = async ()=>{
  const nick = (document.getElementById('sNick').value||'').trim();
  const pin  = (document.getElementById('sPin').value||'').trim();
  if (!nick || !/^\d{4}$/.test(pin)){
    document.getElementById('setHint').textContent = 'Podaj nick i 4-cyfrowy PIN.';
    return;
  }
  const ownerId = await sha256b64(`${nick}|${pin}`);
  localStorage.setItem('utopia_owner_v1', JSON.stringify({ nick, ownerId }));
  document.getElementById('setHint').textContent = 'Zapisano.';
  setTimeout(()=> setDlg.close(), 300);
  render();
};

/* === ADMIN === */
document.getElementById('btnAdminLogin').onclick = async ()=>{
  const pwd = prompt('Hasło administratora:');
  if (!pwd) return;
  const token = await sha256b64(pwd); // backend porównuje z hash w Script Properties
  localStorage.setItem('utopia_admin_token_v1', token);
  alert('Zalogowano admina (lokalnie).');
  render();
};
document.getElementById('btnAdminLogout').onclick = ()=>{
  localStorage.removeItem('utopia_admin_token_v1');
  alert('Wylogowano admina.');
  render();
};

/* START */
addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
