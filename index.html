<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Utopia sprzedaje</title>

<!-- STYLES -->
<style>
:root{
  --bg:#0f1318; --panel:#171d26; --text:#e6e6ea; --muted:#9aa4b2;
  --line:#222a35; --brand:#2d6cdf; --danger:#ef4444; --ok:#22c55e;
  --radius:14px; --radius-sm:10px; --shadow:0 6px 24px rgb(0 0 0 / .25);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
a{color:inherit}
.container{max-width:1100px;margin:24px auto 80px;padding:0 16px}

/* toolbar */
.toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:16px}
.toolbar .pills{display:flex;flex-wrap:wrap;gap:10px}
.pill{padding:10px 14px;border-radius:999px;background:#111621;border:1px solid var(--line);cursor:pointer;user-select:none}
.pill.active{background:#15263b;border-color:#1d3e66}
.toolbar .spacer{flex:1}
.input{height:42px;padding:0 12px;border-radius:10px;border:1px solid var(--line);background:#0f1722;color:var(--text);min-width:0}
.btn{height:42px;padding:0 14px;border-radius:10px;border:1px solid var(--line);background:#0f1722;color:var(--text);cursor:pointer}
.btn.brand{background:#1b2c47}
.btn.ghost{background:#111621}
.btn.ok{background:#11321e;border-color:#1f5a37}
.btn.danger{background:#3a1416;border-color:#5a2023}
.btn:disabled{opacity:.6;cursor:not-allowed}

/* table */
.table-wrap{background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.table-scroll{overflow-x:auto}
table{width:100%;border-collapse:collapse;table-layout:fixed}
th,td{padding:18px 16px;border-bottom:1px solid var(--line);vertical-align:middle;word-wrap:break-word}
th{font-weight:600;color:var(--muted);text-align:left}
.col-lvl{width:70px;text-align:center}
.col-actions{width:120px;text-align:right;white-space:nowrap}
.thumb{width:48px;height:48px;border-radius:8px;object-fit:cover;background:#0b0e13;image-rendering:auto}

/* actions */
.action{display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;
  border:0;border-radius:12px;background:#1e3f67;cursor:pointer;transition:transform .08s ease,background .15s;margin-left:8px}
.action:hover{transform:translateY(-1px);background:#255182}
.action--danger{background:#6b1f21}.action--danger:hover{background:#922629}

/* modals */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgb(0 0 0 / .5);z-index:40;padding:16px}
.modal.open{display:flex}
.dialog{width:100%;max-width:640px;background:var(--panel);border-radius:16px;border:1px solid var(--line);box-shadow:var(--shadow)}
.dialog header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--line)}
.dialog main{padding:16px 18px;display:grid;gap:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
.input, .select, textarea{width:100%}
.select{height:42px;padding:0 12px;border-radius:10px;border:1px solid var(--line);background:#0f1722;color:var(--text)}
textarea{min-height:80px;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1722;color:var(--text);resize:vertical}

/* dropzone */
.dropzone{border:1.5px dashed #334155;background:#0b0f16;border-radius:12px;display:flex;align-items:center;justify-content:center;padding:16px;gap:12px;cursor:pointer;min-height:110px}
.dropzone.drag{outline:2px solid #335ca8}
.dropzone img{width:72px;height:72px;border-radius:10px;object-fit:cover;background:#0b0e13}
.dropzone .dz-hint{color:var(--muted);font-size:14px}

/* toast */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#0b0f16;border:1px solid var(--line);border-radius:12px;padding:10px 14px;color:var(--text);z-index:60;display:none}
.toast.show{display:block}

/* admin floating buttons */
.admin-fab{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:50}
.admin-fab button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#0f1722;color:var(--text);cursor:pointer}

/* small screens */
@media (max-width:640px){
  th:nth-child(3), td:nth-child(3){display:none} /* ukryj kolumnę ILOŚĆ */
  .row{grid-template-columns:1fr}
}
</style>
</head>
<body>
  <div class="container">
    <div class="toolbar">
      <div class="pills" id="typePills">
        <div class="pill" data-type="Legendarny">Legendarny</div>
        <div class="pill" data-type="Heroiczny">Heroiczny</div>
        <div class="pill" data-type="Unikatowy">Unikatowy</div>
        <div class="pill" data-type="Inny">Inny</div>
        <div class="pill active" data-type="Wszystkie">Wszystkie</div>
      </div>

      <button class="pill" id="mineBtn">Twoje oferty</button>
      <button class="pill active" id="allBtn">Wszystkie oferty</button>

      <input id="minLv" class="input" placeholder="min. lv" inputmode="numeric" />
      <input id="maxLv" class="input" placeholder="max. lv" inputmode="numeric" />

      <button class="btn brand" id="searchBtn">szukaj</button>
      <button class="btn ghost" id="resetBtn">reset</button>

      <div class="spacer"></div>

      <button class="btn" id="settingsBtn">Zmień ustawienia</button>
      <button class="btn ok" id="addBtn">+ Dodaj ofertę</button>
    </div>

    <div class="table-wrap">
      <div class="table-scroll">
        <table id="itemsTable" aria-label="Oferty">
          <thead>
            <tr>
              <th class="col-lvl">LVL</th>
              <th>PRZEDMIOT</th>
              <th>ILOŚĆ</th>
              <th>CENA</th>
              <th>KONTAKT DC.</th>
              <th class="col-actions"></th>
            </tr>
          </thead>
          <tbody id="itemsTbody">
            <!-- wiersze renderuje JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Admin FAB -->
  <div class="admin-fab">
    <button id="adminLoginBtn">Zaloguj admina</button>
    <button id="adminLogoutBtn" style="display:none">Wyloguj admina</button>
  </div>

  <!-- Modal: Ustawienia -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true">
      <header>
        <h3>Ustawienia użytkownika</h3>
        <button class="btn ghost" data-close="#settingsModal">✕</button>
      </header>
      <main>
        <div class="row">
          <div>
            <label>Nick (np. z Discorda)</label>
            <input id="nickInput" class="input" placeholder="Twój nick" />
          </div>
          <div>
            <label>PIN (4 cyfry — do identyfikacji właściciela)</label>
            <input id="pinInput" class="input" placeholder="1234" inputmode="numeric" maxlength="4" />
          </div>
        </div>
        <div>
          <label>Kontakt Discord</label>
          <input id="contactInput" class="input" placeholder="np. marek#1234" />
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button class="btn ghost" data-close="#settingsModal">Anuluj</button>
          <button class="btn ok" id="saveSettingsBtn">Zapisz</button>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal: Oferta (dodaj/edytuj) -->
  <div class="modal" id="itemModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true">
      <header>
        <h3 id="itemModalTitle">Nowa oferta</h3>
        <button class="btn ghost" data-close="#itemModal">✕</button>
      </header>
      <main>
        <div class="row">
          <div>
            <label>Typ</label>
            <select id="typeSelect" class="select">
              <option>Legendarny</option>
              <option>Heroiczny</option>
              <option>Unikatowy</option>
              <option>Inny</option>
            </select>
          </div>
          <div>
            <label>LVL</label>
            <input id="lvlInput" class="input" type="number" min="1" placeholder="np. 12" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Ilość (opcjonalnie)</label>
            <input id="qtyInput" class="input" type="number" min="1" placeholder="np. 5" />
          </div>
          <div>
            <label>Cena</label>
            <input id="priceInput" class="input" type="number" min="0" placeholder="np. 50000" />
          </div>
        </div>
        <div>
          <label>Kontakt (domyślnie z ustawień)</label>
          <input id="contactOverrideInput" class="input" placeholder="zostaw puste by użyć z ustawień" />
        </div>

        <div id="dropzone" class="dropzone">
          <img id="previewImg" alt="" style="display:none" />
          <div class="dz-hint">
            <div><strong>Przeciągnij i upuść</strong> obrazek lub <strong>kliknij</strong>, aby wybrać.</div>
            <div>Możesz też <strong>wkleić</strong> (Ctrl+V) po zrzucie ekranu.</div>
          </div>
          <input id="fileInput" type="file" accept="image/*" hidden />
        </div>

        <div style="display:flex;gap:10px;justify-content:space-between;align-items:center">
          <div id="ownerHint" style="color:var(--muted);font-size:13px"></div>
          <div style="display:flex;gap:10px">
            <button class="btn ghost" data-close="#itemModal">Anuluj</button>
            <button class="btn ok" id="saveItemBtn">Zapisz ofertę</button>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Modal: Admin login -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true">
      <header>
        <h3>Logowanie administratora</h3>
        <button class="btn ghost" data-close="#adminModal">✕</button>
      </header>
      <main>
        <div>
          <label>PIN / Hasło admina</label>
          <input id="adminPinInput" class="input" placeholder="****" type="password" />
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button class="btn ghost" data-close="#adminModal">Anuluj</button>
          <button class="btn ok" id="adminLoginConfirmBtn">Zaloguj</button>
        </div>
      </main>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<!-- SCRIPTS -->
<script>
/* ====== KONFIG ====== */
const API_BASE = 'https://script.google.com/macros/s/AKfycbz3W6jwL5Ab1PBw_jjvhsAlXz0OtyCYHLQvSdO97RqXm7ZKuYW8wXeKAeJUYaKW-kjARQ/exec'; // <- podmień!
const IMG_VIA_DRIVE = true; // jeśli masz własny endpoint miniatur -> ustaw na false i edytuj fileIdToUrl()
const STATE_KEY = 'utopiaStateV1';
const ADMIN_KEY = 'utopiaAdminTokenV1';

/* ====== STAN ====== */
const state = {
  items: [],
  filters: { type: 'Wszystkie', minLv: '', maxLv: '', mineOnly: false },
  me: { nick: '', pin: '', contact: '' }, // ownerId = nick#pin
  adminToken: null
};

/* ====== UTILS ====== */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const show = el => el.style.display = '';
const hide = el => el.style.display = 'none';
const toast = (msg, ms=2600) => {
  const t = $('#toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), ms);
};
const ownerId = () => (state.me.nick?.trim().toLowerCase() || '') + '#' + (state.me.pin || '');
const isOwner = item => item?.ownerId && ownerId() && item.ownerId === ownerId();
const isAdmin = () => !!state.adminToken;
const fileIdToUrl = (fileId)=> {
  if (!fileId) return '';
  if (IMG_VIA_DRIVE) return `https://drive.google.com/uc?id=${fileId}`;
  // albo własny apps script:
  // return `${API_BASE}?action=thumb&fileId=${encodeURIComponent(fileId)}`;
};

/* ====== PERSIST ====== */
function loadState(){
  try{
    const s = JSON.parse(localStorage.getItem(STATE_KEY) || '{}');
    Object.assign(state.me, s.me || {});
    Object.assign(state.filters, s.filters || {});
    const adm = localStorage.getItem(ADMIN_KEY);
    state.adminToken = adm || null;
  }catch(e){}
}
function saveState(){
  localStorage.setItem(STATE_KEY, JSON.stringify({ me: state.me, filters: state.filters }));
  if (state.adminToken) localStorage.setItem(ADMIN_KEY, state.adminToken);
  else localStorage.removeItem(ADMIN_KEY);
}

/* ====== API ====== */
async function apiList(){
  const url = `${API_BASE}?action=list&_=${Date.now()}`;
  const r = await fetch(url, {mode:'cors'});
  if (!r.ok) throw new Error('Błąd listy: ' + r.status);
  const data = await r.json();
  return Array.isArray(data) ? data : (data.items || []);
}
async function apiCreateOrUpdate(payload, isEdit){
  const r = await fetch(`${API_BASE}?action=${isEdit?'update':'create'}`, {
    method:'POST', mode:'cors', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({...payload, adminToken: state.adminToken || ''})
  });
  if (!r.ok) throw new Error('Błąd zapisu: ' + r.status);
  return r.json();
}
async function apiDelete(id){
  const r = await fetch(`${API_BASE}?action=delete`, {
    method:'POST', mode:'cors', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({id, adminToken: state.adminToken || '', ownerId: ownerId()})
  });
  if (!r.ok) throw new Error('Błąd usuwania: ' + r.status);
  return r.json();
}
async function apiAdminLogin(pin){
  // jeżeli nie masz endpointu na backendzie, można tymczasowo po prostu przyjąć pin jako token
  try{
    const r = await fetch(`${API_BASE}?action=adminLogin`, {
      method:'POST', mode:'cors', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({pin})
    });
    if (r.ok){
      const data = await r.json();
      return data.token || pin;
    }
  }catch(e){
    // fallback: brak endpointu — token = pin (BE i tak MUSI weryfikować po swojej stronie!)
  }
  return pin;
}

/* ====== RENDER ====== */
function renderPills(){
  $$('#typePills .pill').forEach(p=>{
    p.classList.toggle('active', p.dataset.type === state.filters.type);
  });
  $('#mineBtn').classList.toggle('active', state.filters.mineOnly);
  $('#allBtn').classList.toggle('active', !state.filters.mineOnly);
}
function applyFilters(items){
  return items.filter(it=>{
    if (state.filters.type !== 'Wszystkie' && it.type !== state.filters.type) return false;
    if (state.filters.mineOnly && !isOwner(it)) return false;
    const lv = Number(it.lvl)||0;
    const min = Number(state.filters.minLv)||-Infinity;
    const max = Number(state.filters.maxLv)||Infinity;
    if (lv < min || lv > max) return false;
    return true;
  });
}
function renderTable(){
  const tbody = $('#itemsTbody');
  tbody.innerHTML = '';
  const items = applyFilters(state.items);
  if (!items.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="6" style="text-align:center;color:var(--muted);padding:26px">Brak ofert do wyświetlenia.</td>`;
    tbody.appendChild(tr);
    return;
  }
  for (const it of items){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-lvl">${it.lvl ?? ''}</td>
      <td>
        <div style="display:flex;gap:12px;align-items:center">
          <img class="thumb" src="${fileIdToUrl(it.fileId) || ''}" alt="">
          <div>
            <div style="font-weight:600">${escapeHtml(it.type || '')}</div>
            <div style="color:#9aa4b2;font-size:13px">ID: ${escapeHtml(it.id || '')}</div>
          </div>
        </div>
      </td>
      <td>${it.qty ?? ''}</td>
      <td>${it.price ?? ''}</td>
      <td>${escapeHtml(it.contact || '')}</td>
      <td class="col-actions">
        ${ (isOwner(it) || isAdmin()) ? `
          <button class="action" title="Edytuj" data-edit="${it.id}">✎</button>
          <button class="action action--danger" title="Usuń" data-del="${it.id}">✕</button>
        ` : ``}
      </td>
    `;
    tbody.appendChild(tr);
  }
}
function escapeHtml(s=''){
  return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}

/* ====== OBRAZKI (drop/paste) ====== */
let currentImageDataURL = '';
function setupDropzone(){
  const dz = $('#dropzone'), fi = $('#fileInput'), prev = $('#previewImg');
  function setPreview(src){
    currentImageDataURL = src || '';
    if (src){ prev.src = src; prev.style.display=''; }
    else { prev.removeAttribute('src'); prev.style.display='none'; }
  }
  dz.addEventListener('click', ()=>fi.click());
  dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.classList.add('drag'); });
  dz.addEventListener('dragleave', ()=>dz.classList.remove('drag'));
  dz.addEventListener('drop', async e=>{
    e.preventDefault(); dz.classList.remove('drag');
    const f = e.dataTransfer.files?.[0]; if (!f) return;
    const url = await readFileAsDataURL(f);
    setPreview(await downscaleIfNeeded(url, 1200)); // lekkie zmniejszenie dla Drive
  });
  fi.addEventListener('change', async e=>{
    const f=e.target.files?.[0]; if (!f) return;
    const url = await readFileAsDataURL(f);
    setPreview(await downscaleIfNeeded(url, 1200));
  });
  document.addEventListener('paste', async e=>{
    if (!$('#itemModal').classList.contains('open')) return;
    const item = e.clipboardData.items[0];
    if (item && item.type.startsWith('image/')){
      const f = item.getAsFile();
      const url = await readFileAsDataURL(f);
      setPreview(await downscaleIfNeeded(url, 1200));
    }
  });
}
function readFileAsDataURL(file){
  return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
}
function downscaleIfNeeded(dataURL, maxW){
  return new Promise((resolve)=>{
    const img=new Image(); img.onload=()=>{
      const scale = Math.min(1, maxW / img.width);
      if (scale === 1){ resolve(dataURL); return; }
      const c = document.createElement('canvas');
      c.width = Math.round(img.width*scale); c.height = Math.round(img.height*scale);
      const ctx=c.getContext('2d'); ctx.imageSmoothingEnabled=true; ctx.drawImage(img,0,0,c.width,c.height);
      resolve(c.toDataURL('image/jpeg', .9));
    }; img.src = dataURL;
  });
}

/* ====== MODALE + FORM ====== */
function openModal(id){ const m=$(id); m.classList.add('open'); m.setAttribute('aria-hidden','false'); }
function closeModal(id){ const m=$(id); m.classList.remove('open'); m.setAttribute('aria-hidden','true'); }
$$('[data-close]').forEach(b=> b.addEventListener('click', ()=> closeModal(b.dataset.close)));

function fillSettingsUI(){
  $('#nickInput').value = state.me.nick || '';
  $('#pinInput').value = state.me.pin || '';
  $('#contactInput').value = state.me.contact || '';
}
function saveSettingsFromUI(){
  state.me.nick = $('#nickInput').value.trim();
  state.me.pin = ($('#pinInput').value || '').replace(/\D/g,'').slice(0,4);
  state.me.contact = $('#contactInput').value.trim();
  saveState();
  toast('Zapisano ustawienia');
}

let editingItemId = null;
function openItemModal(item=null){
  editingItemId = item?.id || null;
  $('#itemModalTitle').textContent = editingItemId ? 'Edytuj ofertę' : 'Nowa oferta';
  $('#typeSelect').value = item?.type || 'Legendarny';
  $('#lvlInput').value = item?.lvl ?? '';
  $('#qtyInput').value = item?.qty ?? '';
  $('#priceInput').value = item?.price ?? '';
  $('#contactOverrideInput').value = item?.contact && item.contact !== state.me.contact ? item.contact : '';
  currentImageDataURL = ''; // czyścimy — obrazek jest opcjonalny przy edycji
  $('#previewImg').style.display='none';
  $('#ownerHint').textContent = state.me.nick && state.me.pin ? `Właściciel: ${ownerId()}` : 'Uzupełnij ustawienia (nick + PIN), aby móc edytować później.';
  openModal('#itemModal');
}

async function saveItemFromUI(){
  // walidacja minimalna
  const payload = {
    id: editingItemId || undefined,
    type: $('#typeSelect').value,
    lvl: Number($('#lvlInput').value||0),
    qty: $('#qtyInput').value ? Number($('#qtyInput').value) : undefined,
    price: Number($('#priceInput').value||0),
    contact: ($('#contactOverrideInput').value.trim() || state.me.contact || ''),
    ownerId: ownerId(),
    imageBase64: currentImageDataURL || undefined
  };
  if (!payload.lvl || !payload.price){ toast('Uzupełnij LVL i CENĘ'); return; }
  if (!payload.ownerId || payload.ownerId === '#'){ toast('Uzupełnij ustawienia (nick + PIN)'); return; }
  try{
    await apiCreateOrUpdate(payload, !!editingItemId);
    closeModal('#itemModal');
    toast(editingItemId ? 'Zapisano zmiany' : 'Dodano ofertę');
    await refreshList();
  }catch(e){
    console.error(e); toast('Błąd zapisu: ' + String(e.message||e));
  }
}

/* ====== ZDARZENIA UI ====== */
function bindUI(){
  // pills typów
  $$('#typePills .pill').forEach(p=>{
    p.addEventListener('click', ()=>{
      state.filters.type = p.dataset.type;
      renderPills(); saveState(); renderTable();
    });
  });
  // Twoje/Wszystkie
  $('#mineBtn').addEventListener('click', ()=>{ state.filters.mineOnly = true; renderPills(); saveState(); renderTable(); });
  $('#allBtn').addEventListener('click', ()=>{ state.filters.mineOnly = false; renderPills(); saveState(); renderTable(); });

  // min/max
  $('#searchBtn').addEventListener('click', ()=>{
    state.filters.minLv = $('#minLv').value.trim();
    state.filters.maxLv = $('#maxLv').value.trim();
    saveState(); renderTable();
  });
  $('#resetBtn').addEventListener('click', ()=>{
    state.filters = { type:'Wszystkie', minLv:'', maxLv:'', mineOnly:false };
    $('#minLv').value=''; $('#maxLv').value='';
    renderPills(); saveState(); renderTable();
  });

  // ustawienia
  $('#settingsBtn').addEventListener('click', ()=>{ fillSettingsUI(); openModal('#settingsModal'); });
  $('#saveSettingsBtn').addEventListener('click', ()=>{ saveSettingsFromUI(); closeModal('#settingsModal'); });

  // oferta
  $('#addBtn').addEventListener('click', ()=> openItemModal(null));
  $('#saveItemBtn').addEventListener('click', saveItemFromUI);

  // kliknięcia w tabeli (delegacja)
  $('#itemsTbody').addEventListener('click', (e)=>{
    const editId = e.target.closest('[data-edit]')?.dataset.edit;
    const delId  = e.target.closest('[data-del]')?.dataset.del;
    if (editId){
      const it = state.items.find(i=>i.id===editId);
      if (it){ openItemModal(it); }
    }else if (delId){
      confirmDelete(delId);
    }
  });

  // admin
  $('#adminLoginBtn').addEventListener('click', ()=> openModal('#adminModal'));
  $('#adminLoginConfirmBtn').addEventListener('click', async ()=>{
    const pin = $('#adminPinInput').value.trim();
    if (!pin){ toast('Podaj PIN'); return; }
    state.adminToken = await apiAdminLogin(pin);
    saveState();
    closeModal('#adminModal');
    toast('Zalogowano admina');
    updateAdminButtons();
    renderTable();
  });
  $('#adminLogoutBtn').addEventListener('click', ()=>{
    state.adminToken = null; saveState(); updateAdminButtons(); renderTable();
  });
}
function updateAdminButtons(){
  if (isAdmin()){ hide($('#adminLoginBtn')); show($('#adminLogoutBtn')); }
  else { show($('#adminLoginBtn')); hide($('#adminLogoutBtn')); }
}

async function confirmDelete(id){
  if (!confirm('Na pewno usunąć tę ofertę?')) return;
  try{
    await apiDelete(id);
    toast('Usunięto');
    await refreshList();
  }catch(e){
    console.error(e); toast('Błąd usuwania: ' + String(e.message||e));
  }
}

/* ====== LISTA ====== */
async function refreshList(){
  try{
    const items = await apiList();
    // sanity: dopisz kontakt z pól pustych, jeśli backend nie zwraca
    state.items = (items||[]).map(x=>({
      id: String(x.id || x.ID || ''),
      type: x.type || x.Type || '',
      lvl: Number(x.lvl ?? x.level ?? x.LVL ?? 0),
      price: Number(x.price ?? x.Price ?? 0),
      qty: (x.qty ?? x.ilosc ?? x.quantity) ? Number(x.qty ?? x.ilosc ?? x.quantity) : '',
      contact: x.contact || x.kontakt || '',
      ownerId: x.ownerId || x.owner || '',
      fileId: x.fileId || x.file_id || ''
    }));
    renderTable();
  }catch(e){
    console.error(e);
    toast('Nie udało się pobrać listy (sprawdź URL w API_BASE)');
    state.items = []; renderTable();
  }
}

/* ====== START ====== */
(function init(){
  loadState();
  $('#minLv').value = state.filters.minLv || '';
  $('#maxLv').value = state.filters.maxLv || '';
  renderPills();
  updateAdminButtons();
  bindUI();
  setupDropzone();
  refreshList();

  // klik poza dialog — zamknięcie
  $$('.modal').forEach(m=>{
    m.addEventListener('click',e=>{ if(e.target===m) m.classList.remove('open'); });
  });
})();
</script>
</body>
</html>
